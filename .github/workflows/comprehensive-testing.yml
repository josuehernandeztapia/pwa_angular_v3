name: ðŸ§ª Comprehensive Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.x'
  CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
  PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
  PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== STATIC ANALYSIS & LINTING =====
  static-analysis:
    name: ðŸ” Static Analysis
    runs-on: ubuntu-latest
    outputs:
      affected-projects: ${{ steps.affected.outputs.projects }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ§¹ Run ESLint
        run: |
          npm run lint
          npm run lint:report
        continue-on-error: false

      - name: ðŸŽ¯ TypeScript Compilation Check
        run: npm run build:check

      - name: ðŸ”’ Security Audit
        run: |
          npm audit --audit-level moderate
          npm run security:check
        continue-on-error: true

      - name: ðŸ“Š Bundle Analysis
        run: |
          npm run build:analyze
          npm run bundle:size-check

      - name: ðŸ“¤ Upload ESLint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: reports/eslint/

  # ===== UNIT TESTING =====
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [static-analysis]
    strategy:
      matrix:
        test-suite: 
          - services
          - components
          - utilities
          - integration

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ§ª Run Unit Tests - ${{ matrix.test-suite }}
        run: |
          case "${{ matrix.test-suite }}" in
            "services")
              npm run test:services -- --code-coverage
              ;;
            "components")
              npm run test:components -- --code-coverage
              ;;
            "utilities")
              npm run test:utilities -- --code-coverage
              ;;
            "integration")
              npm run test:integration -- --code-coverage
              ;;
          esac

      - name: ðŸ“Š Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.test-suite }}
          path: coverage/

      - name: ðŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: reports/tests/

  # ===== CONTRACT TESTING =====
  contract-tests:
    name: ðŸ“œ Contract Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ”„ Install Pact CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/pact-foundation/pact-ruby-standalone/master/install.sh | bash
          export PATH="$PATH:$HOME/pact/bin"

      - name: ðŸ§ª Run Pact Consumer Tests
        run: npm run test:pact:consumer

      - name: ðŸ“¤ Publish Pact Contracts
        if: github.ref == 'refs/heads/main'
        run: |
          export PATH="$PATH:$HOME/pact/bin"
          pact-broker publish pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --broker-base-url ${{ env.PACT_BROKER_BASE_URL }} \
            --broker-token ${{ env.PACT_BROKER_TOKEN }}

      - name: ðŸ” Can I Deploy?
        if: github.event_name == 'pull_request'
        run: |
          export PATH="$PATH:$HOME/pact/bin"
          pact-broker can-i-deploy \
            --pacticipant conductores-pwa-frontend \
            --version ${{ github.sha }} \
            --to-environment production \
            --broker-base-url ${{ env.PACT_BROKER_BASE_URL }} \
            --broker-token ${{ env.PACT_BROKER_TOKEN }}

      - name: ðŸ“¤ Upload Contract Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pact-results
          path: |
            pacts/
            reports/pact/

  # ===== ACCESSIBILITY TESTING =====
  accessibility-tests:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    needs: [static-analysis]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ—ï¸ Build application
        run: npm run build:prod

      - name: ðŸš€ Start application server
        run: |
          npm run serve:prod &
          npx wait-on http://localhost:4200 --timeout 60000

      - name: â™¿ Run Accessibility Tests
        run: |
          npm run test:a11y
          npm run test:a11y:report

      - name: ðŸ“¤ Upload Accessibility Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: reports/accessibility/

  # ===== VISUAL REGRESSION TESTING =====
  visual-tests:
    name: ðŸ“¸ Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [static-analysis]
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        device: [desktop, tablet, mobile]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ—ï¸ Build application
        run: npm run build:prod

      - name: ðŸš€ Start application server
        run: |
          npm run serve:prod &
          npx wait-on http://localhost:4200 --timeout 60000

      - name: ðŸ“¸ Run Visual Tests
        run: |
          npm run test:visual:${{ matrix.browser }} -- --project=${{ matrix.device }}
        env:
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}

      - name: ðŸ“¤ Upload Visual Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-results-${{ matrix.browser }}-${{ matrix.device }}
          path: |
            test-results/
            visual-report/

  # ===== E2E TESTING =====
  e2e-tests:
    name: ðŸ”„ E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        test-suite: [auth, dashboard, clients, quotes, documents, performance]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ—ï¸ Build application
        run: npm run build:prod

      - name: ðŸš€ Start application & API mock server
        run: |
          npm run serve:prod &
          npm run mock:api &
          npx wait-on http://localhost:4200 http://localhost:3000 --timeout 120000

      - name: ðŸ§ª Run E2E Tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          browser: ${{ matrix.browser }}
          spec: cypress/e2e/*${{ matrix.test-suite }}*.cy.ts
          record: true
          parallel: true
          group: 'E2E-${{ matrix.browser }}-${{ matrix.test-suite }}'
        env:
          CYPRESS_RECORD_KEY: ${{ env.CYPRESS_RECORD_KEY }}

      - name: ðŸ“¤ Upload E2E Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.browser }}-${{ matrix.test-suite }}
          path: |
            cypress/videos/
            cypress/screenshots/
            cypress/reports/

  # ===== PERFORMANCE TESTING =====
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [e2e-tests]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ—ï¸ Build application for performance
        run: npm run build:prod:performance

      - name: ðŸš€ Start production server
        run: |
          npm run serve:prod &
          npm run mock:api &
          npx wait-on http://localhost:4200 http://localhost:3000 --timeout 60000

      - name: ðŸ“Š Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: ðŸ”§ Install k6
        run: |
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: âš¡ Run Load Tests
        run: |
          k6 run --out json=load-test-results.json src/tests/load/dashboard-load.test.js
          k6 run --out json=api-performance-results.json src/tests/load/api-performance.test.js

      - name: ðŸ“Š Generate Performance Report
        run: npm run performance:report

      - name: ðŸ“¤ Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            lighthouse-reports/
            k6-results/
            reports/performance/

  # ===== CHAOS ENGINEERING =====
  chaos-tests:
    name: ðŸŒªï¸ Chaos Engineering
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: github.event_name == 'schedule' || github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸŒªï¸ Run Chaos Tests
        run: |
          npm run test:chaos
          npm run chaos:report

      - name: ðŸ“¤ Upload Chaos Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-results
          path: reports/chaos/

  # ===== MUTATION TESTING =====
  mutation-tests:
    name: ðŸ§¬ Mutation Testing
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'schedule' || github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ§¬ Run Mutation Tests
        run: |
          npm run test:mutation
          npm run mutation:report
        timeout-minutes: 60

      - name: ðŸ“¤ Upload Mutation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-results
          path: reports/mutation/

  # ===== COVERAGE CONSOLIDATION =====
  coverage-consolidation:
    name: ðŸ“Š Coverage Consolidation
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, contract-tests]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ“¥ Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports/
          merge-multiple: true

      - name: ðŸ“Š Merge coverage reports
        run: |
          npm run coverage:merge
          npm run coverage:report

      - name: ðŸ“¤ Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/merged/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ðŸ” SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@master
        with:
          args: >
            -Dsonar.organization=conductores-pwa
            -Dsonar.projectKey=conductores-pwa-frontend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.inclusions=src/**/*.ts
            -Dsonar.test.inclusions=src/**/*.spec.ts
            -Dsonar.typescript.lcov.reportPaths=coverage/merged/lcov.info
            -Dsonar.javascript.lcov.reportPaths=coverage/merged/lcov.info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}

      - name: ðŸ“¤ Upload Final Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: final-coverage-report
          path: coverage/merged/

  # ===== QUALITY GATES =====
  quality-gates:
    name: ðŸš¦ Quality Gates
    runs-on: ubuntu-latest
    needs: [
      static-analysis,
      unit-tests,
      contract-tests,
      accessibility-tests,
      visual-tests,
      e2e-tests,
      performance-tests,
      coverage-consolidation
    ]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ“¥ Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results/

      - name: ðŸš¦ Evaluate Quality Gates
        run: |
          npm run quality:gates
        env:
          MINIMUM_COVERAGE: 90
          MAX_BUNDLE_SIZE: 5242880  # 5MB
          MAX_LIGHTHOUSE_SCORE: 90
          MAX_ACCESSIBILITY_VIOLATIONS: 0

      - name: ðŸ“Š Generate Quality Report
        run: |
          npm run quality:report
          npm run quality:badge

      - name: ðŸ“¤ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: reports/quality/

      - name: ðŸ’¬ Comment PR with Quality Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const qualitySummary = fs.readFileSync('reports/quality/summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: qualitySummary
            });

  # ===== DEPLOYMENT READINESS =====
  deployment-readiness:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš¦ All Tests Passed
        run: |
          echo "âœ… All quality gates passed!"
          echo "ðŸš€ Application is ready for deployment"

      - name: ðŸ“¦ Create Release Artifact
        run: |
          npm run build:prod
          tar -czf conductores-pwa-${{ github.sha }}.tar.gz dist/

      - name: ðŸ“¤ Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact
          path: conductores-pwa-${{ github.sha }}.tar.gz

      - name: ðŸ·ï¸ Create Release Tag
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a v1.${{ github.run_number }} -m "Release v1.${{ github.run_number }}"
          git push origin v1.${{ github.run_number }}

  # ===== NOTIFICATION =====
  notification:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: always()

    steps:
      - name: ðŸ“Š Pipeline Status
        run: |
          if [[ "${{ needs.deployment-readiness.result }}" == "success" ]]; then
            echo "âœ… Pipeline completed successfully!"
            echo "STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Pipeline failed!"
            echo "STATUS=failure" >> $GITHUB_ENV
          fi

      - name: ðŸ”” Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ env.STATUS }}
          channel: '#engineering'
          text: |
            ðŸ§ª Testing Pipeline ${{ env.STATUS == 'success' && 'Completed' || 'Failed' }}
            
            ðŸ“‹ **Branch:** ${{ github.ref }}
            ðŸ‘¤ **Author:** ${{ github.actor }}
            ðŸ”— **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ðŸ“Š **Test Results:**
            - Unit Tests: ${{ needs.unit-tests.result }}
            - E2E Tests: ${{ needs.e2e-tests.result }}
            - Performance: ${{ needs.performance-tests.result }}
            - Accessibility: ${{ needs.accessibility-tests.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ===== CLEANUP =====
cleanup:
  name: ðŸ§¹ Cleanup
  runs-on: ubuntu-latest
  needs: [notification]
  if: always()

  steps:
    - name: ðŸ—‘ï¸ Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const oldArtifacts = artifacts.data.artifacts
            .filter(artifact => {
              const age = new Date() - new Date(artifact.created_at);
              return age > 7 * 24 * 60 * 60 * 1000; // 7 days
            });
          
          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
          }