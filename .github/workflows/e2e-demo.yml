name: ðŸŽ¥ PWA E2E Video Demo Generation

on:
  workflow_dispatch:
    inputs:
      demo_type:
        description: 'Type of demo to generate'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - login-only
          - cotizador-only
          - avi-only

jobs:
  e2e-demo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps

      - name: ðŸ—ï¸ Build application
        run: npm run build

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run E2E tests with video recording
        run: |
          case "${{ github.event.inputs.demo_type }}" in
            "login-only")
              npx playwright test tests/e2e/login-flow.spec.ts --project=chromium
              ;;
            "cotizador-only")
              npx playwright test tests/e2e/cotizador-*.spec.ts --project=chromium
              ;;
            "avi-only")
              npx playwright test tests/e2e/avi-flow.spec.ts --project=chromium
              ;;
            *)
              npm run test:e2e
              ;;
          esac
        continue-on-error: true

      - name: ðŸŽ¬ Concatenate demo videos
        run: |
          # Install FFmpeg
          sudo apt-get update
          sudo apt-get install -y ffmpeg

          # Run concatenation script
          chmod +x scripts/concat-videos.sh
          ./scripts/concat-videos.sh
        continue-on-error: true

      - name: ðŸ“Š Generate video report
        run: |
          echo "# ðŸŽ¥ PWA E2E Demo Video Report" > VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "**Generated**: $(date)" >> VIDEO-REPORT.md
          echo "**Demo Type**: ${{ github.event.inputs.demo_type }}" >> VIDEO-REPORT.md
          echo "**Environment**: GitHub Actions" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "## ðŸ“¹ Generated Videos" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md

          if [ -f "reports/videos/pwa-e2e-demo.mp4" ]; then
            VIDEO_SIZE=$(du -h reports/videos/pwa-e2e-demo.mp4 | cut -f1)
            echo "- **Final Demo**: \`pwa-e2e-demo.mp4\` (${VIDEO_SIZE})" >> VIDEO-REPORT.md
            echo "- **Status**: âœ… Successfully generated" >> VIDEO-REPORT.md
          else
            echo "- **Status**: âŒ Video generation failed" >> VIDEO-REPORT.md
          fi

          echo "" >> VIDEO-REPORT.md
          echo "## ðŸŽ¯ Demo Flows Covered" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "1. **ðŸš€ Login & Authentication** - Professional login flow" >> VIDEO-REPORT.md
          echo "2. **ðŸ’° Cotizador Aguascalientes** - 25.5% rate demonstration" >> VIDEO-REPORT.md
          echo "3. **ðŸ’° Cotizador Estado de MÃ©xico** - 29.9% high-risk rate" >> VIDEO-REPORT.md
          echo "4. **ðŸŽ¤ AVI Voice Interview** - GO/REVIEW/NO-GO decision flow" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "## ðŸ“Š Technical Details" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "- **Resolution**: 1280x720 HD" >> VIDEO-REPORT.md
          echo "- **Format**: MP4 (H.264)" >> VIDEO-REPORT.md
          echo "- **Browser**: Chromium" >> VIDEO-REPORT.md
          echo "- **Recording**: Playwright video capture" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "---" >> VIDEO-REPORT.md
          echo "" >> VIDEO-REPORT.md
          echo "ðŸŽ¬ **Ready for download as GitHub Actions artifact**" >> VIDEO-REPORT.md

      - name: ðŸ“¤ Upload demo video artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pwa-e2e-demo-${{ github.event.inputs.demo_type }}-${{ github.run_number }}
          path: |
            reports/videos/pwa-e2e-demo.mp4
            VIDEO-REPORT.md
          retention-days: 30

      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results-${{ github.run_number }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: ðŸ“ Comment on workflow
        if: always()
        run: |
          echo "## ðŸŽ¬ E2E Video Demo Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "reports/videos/pwa-e2e-demo.mp4" ]; then
            VIDEO_SIZE=$(du -h reports/videos/pwa-e2e-demo.mp4 | cut -f1)
            echo "âœ… **Video Generated Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "- **File**: \`pwa-e2e-demo.mp4\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: ${VIDEO_SIZE}" >> $GITHUB_STEP_SUMMARY
            echo "- **Demo Type**: ${{ github.event.inputs.demo_type }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ Download Instructions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Actions** â†’ **Artifacts**" >> $GITHUB_STEP_SUMMARY
            echo "2. Download \`pwa-e2e-demo-${{ github.event.inputs.demo_type }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Extract and view \`pwa-e2e-demo.mp4\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Video Generation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Demo Flows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Professional Login & Dashboard Navigation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’° Cotizador Aguascalientes (25.5% rate)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’° Cotizador Estado de MÃ©xico (29.9% rate)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¤ AVI Voice Interview (GO decision)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¬ **Professional PWA Demo Complete!**" >> $GITHUB_STEP_SUMMARY