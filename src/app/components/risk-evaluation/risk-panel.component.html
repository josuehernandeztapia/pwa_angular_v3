<section
  class="risk-panel"
  data-testid="risk-panel"
  [class.risk-panel--visible]="isVisible()"
  [class.risk-panel--loading]="isLoading()"
>
  <section
    *ngIf="isLoading()"
    class="risk-panel__state risk-panel__state--loading"
    data-testid="evaluation-loading"
  >
    <app-ui-icon class="risk-panel__state-icon" name="refresh" size="md"></app-ui-icon>
    <app-human-message
      class="risk-panel__state-message"
      message-context="loading-evaluation"
      [show-animation]="true"
    ></app-human-message>
  </section>

  <section
    *ngIf="hasError()"
    class="risk-panel__state risk-panel__state--error"
    data-testid="api-error-message"
  >
    <app-ui-icon class="risk-panel__state-icon" name="alert-triangle"></app-ui-icon>
    <app-human-message
      class="risk-panel__state-message"
      message-context="evaluation-error"
      [show-retry]="true"
      (retry)="onRetryEvaluation()"
    ></app-human-message>
    <button type="button" class="risk-panel__button risk-panel__button--primary" (click)="onRetryEvaluation()">
      Reintentar evaluación
    </button>
  </section>

  <section
    *ngIf="!isLoading() && !hasError() && riskEvaluation()"
    class="risk-panel__body"
  >
    <header class="risk-panel__header">
      <div class="risk-panel__title-group">
        <app-ui-icon class="risk-panel__title-icon" name="proteccion"></app-ui-icon>
        <div>
          <h2 class="risk-panel__title">Evaluación de Riesgo KIBAN/HASE</h2>
          <div class="risk-panel__meta">
            <span class="risk-panel__meta-item risk-panel__meta-item--time">
              Procesado en {{ riskEvaluation()?.processingTimeMs }}ms
            </span>
            <span class="risk-panel__meta-item risk-panel__meta-item--version">
              {{ riskEvaluation()?.algorithmVersion }}
            </span>
          </div>
        </div>
      </div>
    </header>

    <section class="risk-panel__section risk-panel__section--kiban">
      <div class="risk-panel__score">
        <div class="risk-panel__score-main">
          <span
            class="risk-panel__score-value"
            [ngClass]="getScoreClass()"
            data-testid="kiban-score"
          >
            {{ riskEvaluation()?.kiban.scoreRaw || 'N/A' }}
          </span>
          <span
            class="risk-panel__score-band"
            [ngClass]="getBandClass()"
            data-testid="score-band"
          >
            Banda {{ riskEvaluation()?.kiban.scoreBand }}
          </span>
        </div>

        <div class="risk-panel__score-summary">
          <app-ui-icon class="risk-panel__score-icon" name="cotizador"></app-ui-icon>
          <div class="risk-panel__score-details">
            <div class="risk-panel__score-detail">
              <span class="risk-panel__score-detail-label">Score final</span>
              <span class="risk-panel__score-detail-value">
                {{ riskEvaluation()?.scoreBreakdown.finalScore }}/100
              </span>
            </div>
            <div class="risk-panel__score-detail">
              <span class="risk-panel__score-detail-label">Confianza</span>
              <span class="risk-panel__score-detail-value">
                {{ riskEvaluation()?.confidenceLevel }}%
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="risk-panel__score-visualization" data-testid="score-visualization">
        <div class="risk-panel__score-bar">
          <div
            class="risk-panel__score-progress"
            [style.width.%]="getScorePercentage()"
            [ngClass]="getScoreProgressClass()"
          ></div>
        </div>
        <div class="risk-panel__score-scale">
          <span>0</span>
          <span>300</span>
          <span>500</span>
          <span>700</span>
          <span>850</span>
        </div>
      </div>
    </section>

    <section class="risk-panel__section risk-panel__section--hase">
      <header class="risk-panel__section-header">
        <app-ui-icon class="risk-panel__section-icon" name="simulador"></app-ui-icon>
        <h3 class="risk-panel__section-title">HASE · Análisis integral</h3>
      </header>

      <div
        class="risk-panel__hase-category"
        [ngClass]="getHaseCategoryClass()"
        data-testid="hase-category"
      >
        <span class="risk-panel__hase-label">{{ riskEvaluation()?.hase.category }}</span>
        <span class="risk-panel__hase-score">
          {{ (riskEvaluation()?.hase.riskScore01 * 100 | number:'1.1-1') }}%
        </span>
      </div>

      <div class="risk-panel__explain-list">
        <div
          *ngFor="let factor of riskEvaluation()?.hase.explain"
          class="risk-panel__explain-item"
          [ngClass]="getFactorImpactClass(factor.impact)"
        >
          <app-ui-icon class="risk-panel__explain-icon" [name]="getFactorIcon(factor.factor)"></app-ui-icon>
          <div class="risk-panel__explain-details">
            <span class="risk-panel__explain-name">{{ getFactorDisplayName(factor.factor) }}</span>
            <div class="risk-panel__explain-weight">
              <span class="risk-panel__explain-weight-value">
                {{ (factor.weight * 100 | number:'1.0-0') }}%
              </span>
              <span class="risk-panel__impact-badge" [ngClass]="getImpactClass(factor.impact)">
                {{ getImpactDisplay(factor.impact) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section
      class="risk-panel__section risk-panel__section--factors"
      *ngIf="riskEvaluation()?.riskFactors?.length"
    >
      <header class="risk-panel__section-header">
        <app-ui-icon class="risk-panel__section-icon" name="alert-triangle"></app-ui-icon>
        <h3 class="risk-panel__section-title">Factores de riesgo identificados</h3>
      </header>

      <div class="risk-panel__risk-factors">
        <article
          *ngFor="let factor of getDisplayRiskFactors()"
          class="risk-panel__risk-factor"
          [ngClass]="getSeverityClass(factor.severity)"
          data-testid="risk-reason"
        >
          <div class="risk-panel__risk-factor-icon">
            <app-ui-icon [name]="getSeverityIcon(factor.severity)"></app-ui-icon>
          </div>
          <div class="risk-panel__risk-factor-body">
            <h4 class="risk-panel__risk-factor-name">{{ factor.factorName }}</h4>
            <p class="risk-panel__risk-factor-description">{{ factor.description }}</p>

            <div class="risk-panel__risk-factor-impact">
              <span class="risk-panel__risk-factor-impact-label">Impacto en score</span>
              <span
                class="risk-panel__risk-factor-impact-value"
                [class.risk-panel__risk-factor-impact-value--positive]="factor.scoreImpact >= 0"
                [class.risk-panel__risk-factor-impact-value--negative]="factor.scoreImpact < 0"
              >
                {{ factor.scoreImpact >= 0 ? '+' : '' }}{{ factor.scoreImpact }}
              </span>
            </div>

            <div
              class="risk-panel__mitigations"
              *ngIf="factor.mitigationRecommendations?.length"
            >
              <h5 class="risk-panel__mitigations-title">Recomendaciones</h5>
              <ul class="risk-panel__mitigations-list">
                <li
                  *ngFor="let rec of factor.mitigationRecommendations"
                  class="risk-panel__mitigations-item"
                >
                  {{ rec }}
                </li>
              </ul>
            </div>
          </div>
        </article>
      </div>
    </section>

    <section class="risk-panel__section risk-panel__section--decision">
      <header class="risk-panel__section-header">
        <app-ui-icon class="risk-panel__section-icon" [name]="getDecisionIcon()"></app-ui-icon>
        <h3 class="risk-panel__section-title">Decisión final</h3>
      </header>

      <div class="risk-panel__decision-result">
        <span
          class="risk-panel__decision-chip"
          [ngClass]="getDecisionClass()"
          data-testid="decision-chip"
        >
          <span class="risk-panel__decision-label" data-testid="decision-gate">
            {{ getDecisionDisplay() }}
          </span>
        </span>
        <span class="risk-panel__decision-confidence">
          Confianza: {{ riskEvaluation()?.confidenceLevel }}%
        </span>
      </div>

      <div class="risk-panel__decision-message">
        <app-human-message
          [message-context]="getDecisionMessageContext()"
          [personalization-data]="getPersonalizationData()"
          [show-animation]="true"
        ></app-human-message>
      </div>

      <ul class="risk-panel__decision-reasons" *ngIf="riskEvaluation()?.decisionReasons?.length">
        <li
          *ngFor="let reason of riskEvaluation()?.decisionReasons"
          class="risk-panel__decision-reason"
        >
          {{ reason }}
        </li>
      </ul>
    </section>

    <section
      class="risk-panel__section risk-panel__section--financial"
      *ngIf="riskEvaluation()?.financialRecommendations"
    >
      <header class="risk-panel__section-header">
        <app-ui-icon class="risk-panel__section-icon" name="cotizador"></app-ui-icon>
        <h3 class="risk-panel__section-title">Recomendaciones financieras</h3>
      </header>

      <div class="risk-panel__financial-grid">
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Monto máximo</span>
          <span class="risk-panel__financial-value risk-panel__financial-value--currency">
            {{ getFormattedMaxLoanAmount() }}
          </span>
        </div>
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Enganche mínimo</span>
          <span class="risk-panel__financial-value risk-panel__financial-value--currency">
            {{ getFormattedMinDownPayment() }}
          </span>
        </div>
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Plazo máximo</span>
          <span class="risk-panel__financial-value">
            {{ riskEvaluation()?.financialRecommendations.maxTermMonths }} meses
          </span>
        </div>
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Tasa sugerida</span>
          <span class="risk-panel__financial-value">
            {{ riskEvaluation()?.financialRecommendations.suggestedInterestRate }}% anual
          </span>
        </div>
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Pago mensual</span>
          <span class="risk-panel__financial-value risk-panel__financial-value--currency">
            {{ getFormattedEstimatedMonthlyPayment() }}
          </span>
        </div>
        <div class="risk-panel__financial-item">
          <span class="risk-panel__financial-label">Ratio deuda/ingreso</span>
          <span class="risk-panel__financial-value" [ngClass]="getDebtRatioClass()">
            {{ riskEvaluation()?.financialRecommendations.resultingDebtToIncomeRatio }}%
          </span>
        </div>
      </div>
    </section>

    <section
      class="risk-panel__section risk-panel__section--steps"
      *ngIf="riskEvaluation()?.nextSteps?.length || getSuggestions().length"
    >
      <header class="risk-panel__section-header">
        <app-ui-icon class="risk-panel__section-icon" name="check-circle"></app-ui-icon>
        <h3 class="risk-panel__section-title">Siguientes pasos</h3>
      </header>

      <div class="risk-panel__steps-list" *ngIf="riskEvaluation()?.nextSteps?.length">
        <div
          *ngFor="let step of riskEvaluation()?.nextSteps; let i = index"
          class="risk-panel__step"
          [style.animation-delay]="(i * 100) + 'ms'"
        >
          <span class="risk-panel__step-number">{{ i + 1 }}</span>
          <span class="risk-panel__step-content">{{ step }}</span>
        </div>
      </div>

      <div class="risk-panel__actions" *ngIf="getSuggestions().length">
        <div
          *ngFor="let suggestion of getSuggestions()"
          class="risk-panel__action"
          data-testid="mitigation-cta"
        >
          <button
            *ngIf="suggestion.includes('aval')"
            type="button"
            class="risk-panel__button risk-panel__button--primary"
            data-testid="add-guarantor-btn"
            (click)="onAddGuarantor()"
          >
            <app-ui-icon class="risk-panel__button-icon" name="check-circle"></app-ui-icon>
            Agregar aval
          </button>

          <button
            *ngIf="suggestion.includes('plazo')"
            type="button"
            class="risk-panel__button risk-panel__button--secondary"
            data-testid="reduce-term-btn"
            (click)="onReduceTerm()"
          >
            <app-ui-icon class="risk-panel__button-icon" name="clock"></app-ui-icon>
            Ajustar plazo
          </button>

          <button
            *ngIf="suggestion.includes('comprobantes')"
            type="button"
            class="risk-panel__button risk-panel__button--ghost"
            data-testid="upload-documents-btn"
            (click)="onUploadDocuments()"
          >
            <app-ui-icon class="risk-panel__button-icon" name="scan"></app-ui-icon>
            Cargar documentos
          </button>
        </div>
      </div>
    </section>

    <section
      class="risk-panel__section risk-panel__section--notice"
      *ngIf="riskEvaluation()?.kiban.status === 'NOT_FOUND'"
      data-testid="fallback-message"
    >
      <app-ui-icon class="risk-panel__section-icon" name="info"></app-ui-icon>
      <app-human-message
        message-context="not-found-fallback"
        [personalization-data]="getPersonalizationData()"
      ></app-human-message>
    </section>

    <section
      class="risk-panel__section risk-panel__section--notice risk-panel__section--notice-danger"
      *ngIf="riskEvaluation()?.decision === 'NO-GO'"
      data-testid="rejection-message"
    >
      <app-ui-icon class="risk-panel__section-icon" name="alert-circle"></app-ui-icon>
      <app-human-message
        message-context="rejection-explanation"
        [personalization-data]="getPersonalizationData()"
      ></app-human-message>
    </section>
  </section>

  <section
    *ngIf="!isLoading() && !hasError() && !riskEvaluation()"
    class="risk-panel__state risk-panel__state--empty"
  >
    <app-ui-icon class="risk-panel__state-icon" name="info"></app-ui-icon>
    <p class="risk-panel__state-message">No se encontró información de riesgo para este contrato.</p>
  </section>
</section>
