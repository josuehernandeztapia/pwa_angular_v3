<!-- AVI Interview Component -->
<div class="avi-interview-shell" [class.is-recording]="isRecording" [class.is-processing]="isProcessingResponse">
  
  <!-- Header con progreso -->
  <div class="interview-header" *ngIf="isInterviewActive || showResults">
    <div class="progress-section layout-stack-sm">
      <div class="progress-bar" aria-label="Progreso de la entrevista" role="progressbar" [attr.aria-valuenow]="progressPercentage | number:'1.0-0'" aria-valuemin="0" [attr.aria-valuemax]="100">
        <div class="progress-fill" [style.width.%]="progressPercentage"></div>
      </div>
      <div class="progress-info">
        <span class="body-sm">Pregunta {{ currentIndex }} de {{ totalQuestions }}</span>
        <span class="body-xs" *ngIf="estimatedTimeRemaining > 0">
          ~{{ estimatedTimeRemaining.toFixed(1) }}min restantes
        </span>
      </div>
    </div>
  </div>

  <!-- Estado: Antes de comenzar -->
  <div class="interview-start overlay-panel" *ngIf="!isInterviewActive && !showResults">
    <div class="overlay-panel__content interview-start-card">
      <div class="interview-logo layout-stack-sm">
        <span class="logo-icon">
          <app-icon name="microphone" [size]="32" />
        </span>
        <h1>Entrevista AVI</h1>
        <p class="subtitle">Sistema Automatizado de Evaluación Vocal</p>
      </div>
      
      <div class="interview-info layout-stack-md">
        <div class="info-item layout-row-center">
          <app-icon name="document-text" [size]="24" />
          <span>{{ totalQuestions }} preguntas personalizadas</span>
        </div>
        <div class="info-item layout-row-center">
          <app-icon name="clock" [size]="24" />
          <span>~45 minutos de duración</span>
        </div>
        <div class="info-item layout-row-center">
          <app-icon name="beaker" [size]="24" />
          <span>Análisis científico dual engine</span>
        </div>
        <div class="info-item layout-row-center">
          <app-icon name="check-circle-solid" [size]="24" />
          <span>Detección de inconsistencias en tiempo real</span>
        </div>
      </div>
      
      <button class="btn btn-primary start-button" data-testid="avi-start-button" (click)="startInterview()">
        Comenzar Entrevista
      </button>
      <div class="guided-start">
        <button class="btn btn-secondary start-button" (click)="guidedBasicActive = true; startInterview()" title="Flujo guiado: 6 preguntas de Información Básica">
          Guided Básicas (6)
        </button>
      </div>
    </div>
  </div>

  <!-- Estado: Entrevista activa -->
  <div class="interview-active layout-stack-lg" *ngIf="isInterviewActive && currentQuestion">
    <div class="surface-card question-card layout-stack-md">
      <!-- Info de la pregunta -->
      <div class="question-header">
        <div class="question-meta layout-row-between">
          <span class="chip chip--neutral">{{ formatCategoryName(currentQuestion.category) }}</span>
          <span class="chip chip--warning" [class.critical]="currentQuestion.weight >= 8">
            Peso: {{ currentQuestion.weight }}/10
          </span>
          <span class="chip chip--success">
            Estrés: {{ currentQuestion.stressLevel }}/5
          </span>
          <span class="chip chip--neutral audio-indicator" [class.ready]="isAudioReady(currentQuestion.id)">
            <app-icon [name]="isAudioReady(currentQuestion.id) ? 'volume-2' : 'volume-2'" [size]="20" />
            {{ isAudioReady(currentQuestion.id) ? 'Audio listo' : 'Sin audio' }}
          </span>
        </div>
      </div>

      <!-- La pregunta -->
      <div class="question-text layout-stack-sm">
        <h2 tabindex="-1" #questionTitle id="question-title">{{ currentQuestion.question }}</h2>
        <div class="body-sm question-meta-time">
          Tiempo estimado: {{ currentQuestion.estimatedTime }}s
        </div>
        <div class="body-xs question-hint">Responde con normalidad. No hay respuestas correctas o incorrectas.</div>
        <!-- Pill de feedback inmediato para la última respuesta registrada -->
        <div class="pill-feedback" *ngIf="questionPills.length > 0">
          <ng-container *ngIf="questionPills[questionPills.length - 1] as pill">
            <span class="chip" [class.clear]="pill.status==='clear'" [class.review]="pill.status==='review'" [class.evasive]="pill.status==='evasive'">
              {{ pill.label }}
            </span>
            <span class="body-xs pill-reason">{{ pill.reason }}</span>
          </ng-container>
        </div>
      </div>

      <!-- Área de respuesta -->
      <div class="response-area layout-stack-md" [attr.aria-busy]="isProcessingResponse">
        <!-- Estados accesibles -->
        <div class="state-announcer layout-row-center" aria-live="polite">
          <span class="badge badge-neutral" *ngIf="!isRecording && !isProcessingResponse && !lastSavedAt">Listo para grabar</span>
          <span class="badge badge-warning" *ngIf="isRecording">Grabando… ({{ formatTimeMMSS(recordingSeconds) }})</span>
          <span class="badge badge-warning" *ngIf="isProcessingResponse">Procesando respuesta…</span>
          <span class="badge badge-positive" *ngIf="!isRecording && !isProcessingResponse && lastSavedAt">Guardado</span>
        </div>
        <div class="input-container layout-stack-sm">
          <textarea 
            [(ngModel)]="currentResponse"
            placeholder="Escriba su respuesta aquí..."
            class="response-input"
            [disabled]="isProcessingResponse"
            rows="4">
          </textarea>
          
          <!-- Controles de voz -->
          <div class="voice-controls layout-row-center">
            <button 
              class="btn btn-secondary voice-button"
              [class.recording]="isRecording"
              (click)="toggleRecording()"
              [disabled]="isRecording || isProcessingResponse"
              aria-label="Grabar"
              title="Grabar"
              (keydown.enter)="$event.preventDefault(); toggleRecording()"
              (keydown.space)="$event.preventDefault(); toggleRecording()">
              <span class="voice-icon">
                <app-icon name="microphone" [size]="20" />
              </span>
              Grabar
            </button>
            <button 
              class="btn btn-warning voice-button"
              *ngIf="isRecording"
              (click)="toggleRecording()"
              aria-label="Detener"
              title="Detener"
              (keydown.enter)="$event.preventDefault(); toggleRecording()"
              (keydown.space)="$event.preventDefault(); toggleRecording()">
              <span class="voice-icon recording">
                <app-icon name="stop" [size]="20" />
              </span>
              Detener
            </button>
          </div>
        </div>

        <!-- Indicadores de estrés en tiempo real -->
        <div class="stress-indicators" *ngIf="stressIndicators | async as indicators">
          <div class="indicator-list layout-row-center" *ngIf="indicators.length > 0">
            <span class="body-xs">Detectado:</span>
            <span class="chip chip--warning" *ngFor="let indicator of indicators">{{ indicator }}</span>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="action-buttons layout-row-end">
          <button 
            class="btn btn-ghost" 
            (click)="skipQuestion()"
            *ngIf="currentQuestion.weight <= 4"
            [disabled]="isProcessingResponse">
            Saltar
          </button>
          
          <button 
            class="btn btn-primary"
            *ngIf="hasResultReady"
            (click)="submitResponse()"
            [disabled]="isProcessingResponse"
            aria-label="Siguiente"
            title="Siguiente">
            Siguiente
          </button>
        </div>

        <!-- Overlay de procesamiento -->
        <div class="overlay-panel" *ngIf="isProcessingResponse">
          <div class="overlay-panel__content processing-content">Procesando respuesta…</div>
        </div>

        <!-- Preguntas de seguimiento (si las hay) -->
        <div class="follow-up-questions layout-stack-sm" *ngIf="currentQuestion.followUpQuestions && currentQuestion.followUpQuestions.length > 0">
          <div class="heading-sm">Preguntas de seguimiento sugeridas:</div>
          <ul class="follow-up-list layout-stack-xs">
            <li *ngFor="let followUp of currentQuestion.followUpQuestions">{{ followUp }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Estado: Analizando -->
  <div class="analyzing-state" *ngIf="isAnalyzing">
    <section class="card">
      <h2 class="analysis-heading">Resultado AVI</h2>

      <!-- Skeleton Loader -->
      <div class="skeleton-stack">
        <div class="skeleton-line skeleton-line--lg"></div>
        <div class="skeleton-line skeleton-line--lg"></div>
        <div class="skeleton-line skeleton-line--sm skeleton-line--wide"></div>
      </div>

      <p class="analysis-description">Analizando respuestas...</p>
    </section>
  </div>

  <!-- Estado: Resultados -->
  <div class="results-state" *ngIf="showResults && dualEngineResult">
    <div class="results-container">
      <!-- Resultado AVI Minimalista -->
      <section class="card">
        <h2 class="analysis-heading">Resultado AVI</h2>

        <!-- Loader -->
        <div *ngIf="isAnalyzing" class="skeleton-stack">
          <div class="skeleton-line skeleton-line--lg"></div>
          <div class="skeleton-line skeleton-line--lg"></div>
        </div>

        <!-- Resultados -->
        <div *ngIf="!isAnalyzing">
          <div class="result-decision" data-cy="avi-decision">
            {{ finalDecision }}
          </div>
          <ul class="result-flag-list" *ngIf="finalFlags.length > 0">
            <li *ngFor="let flag of finalFlags" class="result-flag" data-cy="avi-flag">
              {{ flag }}
            </li>
          </ul>
        </div>
      </section>
      
      <!-- Score principal -->
      <div class="main-score-card">
        <div class="score-header">
          <h1>Score Final</h1>
          <div class="consensus-level" [class]="dualEngineResult.consensus.level.toLowerCase()">
            Consenso: {{ dualEngineResult.consensus.level }}
          </div>
        </div>
        
        <div class="score-display">
          <div class="consolidated-score" [class]="getRiskLevelClass()">
            <span class="score-number">{{ dualEngineResult.consolidatedScore.totalScore }}</span>
            <span class="score-label">/ 1000</span>
          </div>
          <div class="risk-level" [class]="getRiskLevelClass()">
            {{ dualEngineResult.consolidatedScore.riskLevel }}
          </div>
        </div>
      </div>

      <!-- Comparación de engines -->
      <div class="engines-comparison">
        <div class="engine-result">
          <h3>
            <app-icon name="beaker" [size]="24" class="engine-icon" />
            Engine Científico
          </h3>
          <div class="engine-score">{{ dualEngineResult.scientificScore.totalScore }}</div>
          <div class="engine-risk">{{ dualEngineResult.scientificScore.riskLevel }}</div>
          <div class="engine-time">{{ dualEngineResult.scientificScore.processingTime }}ms</div>
          
          <div class="engine-advantages">
            <div class="advantages-title">Ventajas:</div>
            <ul>
              <li *ngFor="let advantage of dualEngineResult.consensus.scientificAdvantages">
                {{ advantage }}
              </li>
            </ul>
          </div>
        </div>

        <div class="engine-result">
          <h3>
            <app-icon name="check-circle-solid" [size]="24" class="engine-icon" />
            Engine Heurístico
          </h3>
          <div class="engine-score">{{ dualEngineResult.heuristicScore.totalScore }}</div>
          <div class="engine-risk">{{ dualEngineResult.heuristicScore.riskLevel }}</div>
          <div class="engine-time">{{ dualEngineResult.heuristicScore.processingTime }}ms</div>
          
          <div class="engine-advantages">
            <div class="advantages-title">Ventajas:</div>
            <ul>
              <li *ngFor="let advantage of dualEngineResult.consensus.heuristicAdvantages">
                {{ advantage }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Consenso y análisis -->
      <div class="consensus-analysis">
        <h3>Análisis de Consenso</h3>
        <div class="consensus-info">
          <div class="consensus-item">
            <span class="label">Diferencia de Score:</span>
            <span class="value">{{ dualEngineResult.consensus.scoreDifference }} puntos</span>
          </div>
          <div class="consensus-item">
            <span class="label">Acuerdo en Risk Level:</span>
            <span class="value" [class.positive]="dualEngineResult.consensus.riskLevelAgreement">
              {{ dualEngineResult.consensus.riskLevelAgreement ? 'Sí' : 'No' }}
            </span>
          </div>
          <div class="consensus-description">
            {{ dualEngineResult.consensus.agreement }}
          </div>
        </div>
      </div>

      <!-- Red Flags -->
      <div class="red-flags-section" *ngIf="dualEngineResult.consolidatedScore.redFlags.length > 0">
        <h3>
          <app-icon name="exclamation-triangle" [size]="24" class="red-flag-icon" />
          Red Flags Detectadas
        </h3>
        <div class="red-flags-list">
          <div 
            class="red-flag-item" 
            *ngFor="let flag of dualEngineResult.consolidatedScore.redFlags"
            [class]="flag.severity.toLowerCase()">
            <div class="flag-header">
              <span class="flag-severity">{{ flag.severity }}</span>
              <span class="flag-impact">Impacto: {{ flag.impact }}/10</span>
            </div>
            <div class="flag-reason">{{ flag.reason }}</div>
            <div class="flag-question">Pregunta: {{ flag.questionId }}</div>
          </div>
        </div>
      </div>

      <!-- Category Scores -->
      <div class="category-scores">
        <h3>Scores por Categoría</h3>
        <div class="categories-grid">
          <div 
            class="category-item" 
            *ngFor="let entry of getCategoryScoreEntries()">
            <div class="category-name">{{ entry.category }}</div>
            <div class="category-score">{{ entry.score }}</div>
          </div>
        </div>
      </div>

      <!-- Recomendaciones -->
      <div class="recommendations-section">
        <h3>Recomendaciones del Sistema</h3>
        <div class="recommendations-list">
          <div 
            class="recommendation-item" 
            *ngFor="let recommendation of dualEngineResult.recommendations">
            {{ recommendation }}
          </div>
        </div>
      </div>

      <!-- Métricas técnicas -->
      <div class="technical-metrics">
        <h3>Métricas Técnicas</h3>
        <div class="metrics-grid layout-grid-responsive">
          <div class="metric">
            <span class="metric-label">Tiempo Total:</span>
            <span class="metric-value">{{ formatTime(dualEngineResult.processingTime) }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad Científica:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.scientific * 100).toFixed(1) }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad Heurística:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.heuristic * 100).toFixed(1) }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad General:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.overall * 100).toFixed(1) }}%</span>
          </div>
        </div>
      </div>

      <!-- Botones de acción final -->
      <div class="final-actions">
        <button class="btn btn-secondary" (click)="restartInterview()">
          Nueva Entrevista
        </button>
        <button class="btn btn-ghost" disabled>
          Exportar Reporte
        </button>
      </div>
    </div>
  </div>

</div>
