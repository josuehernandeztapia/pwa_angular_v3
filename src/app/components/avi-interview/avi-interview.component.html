<!-- AVI Interview Component -->
<div class="avi-interview-container" [class.is-recording]="isRecording" [class.is-processing]="isProcessingResponse">
  
  <!-- Header con progreso -->
  <div class="interview-header" *ngIf="isInterviewActive || showResults">
    <div class="progress-section">
      <div class="progress-bar" aria-label="Progreso de la entrevista" role="progressbar" [attr.aria-valuenow]="progressPercentage | number:'1.0-0'" aria-valuemin="0" [attr.aria-valuemax]="100">
        <div class="progress-fill" [style.width.%]="progressPercentage"></div>
      </div>
      <div class="progress-info">
        <span class="question-count">Pregunta {{ currentIndex }} de {{ totalQuestions }}</span>
        <span class="time-remaining" *ngIf="estimatedTimeRemaining > 0">
          ~{{ estimatedTimeRemaining.toFixed(1) }}min restantes
        </span>
      </div>
    </div>
  </div>

  <!-- Estado: Antes de comenzar -->
  <div class="interview-start" *ngIf="!isInterviewActive && !showResults">
    <div class="start-card">
      <div class="avi-logo">
        <span class="logo-icon">üé§</span>
        <h1>Entrevista AVI</h1>
        <p class="subtitle">Sistema Automatizado de Evaluaci√≥n Vocal</p>
      </div>
      
      <div class="interview-info">
        <div class="info-item">
          <span class="icon">üìã</span>
          <span>{{ totalQuestions }} preguntas personalizadas</span>
        </div>
        <div class="info-item">
          <span class="icon">‚è±Ô∏è</span>
          <span>~45 minutos de duraci√≥n</span>
        </div>
        <div class="info-item">
          <span class="icon">üî¨</span>
          <span>An√°lisis cient√≠fico dual engine</span>
        </div>
        <div class="info-item">
          <span class="icon">üéØ</span>
          <span>Detecci√≥n de inconsistencias en tiempo real</span>
        </div>
      </div>
      
      <button class="start-btn" (click)="startInterview()">
        Comenzar Entrevista
      </button>
      <div class="guided-start">
        <button class="start-btn secondary" (click)="guidedBasicActive = true; startInterview()" title="Flujo guiado: 6 preguntas de Informaci√≥n B√°sica">
          Guided B√°sicas (6)
        </button>
      </div>
    </div>
  </div>

  <!-- Estado: Entrevista activa -->
  <div class="interview-active" *ngIf="isInterviewActive && currentQuestion">
    <div class="question-card">
      <!-- Info de la pregunta -->
      <div class="question-header">
        <div class="question-meta">
          <span class="category">{{ formatCategoryName(currentQuestion.category) }}</span>
          <span class="weight" [class.critical]="currentQuestion.weight >= 8">
            Peso: {{ currentQuestion.weight }}/10
          </span>
          <span class="stress-level">
            Estr√©s: {{ currentQuestion.stressLevel }}/5
          </span>
          <span class="audio-indicator" [class.ready]="isAudioReady(currentQuestion.id)">
            {{ isAudioReady(currentQuestion.id) ? 'üéß Audio listo' : '‚è∫Ô∏è Sin audio' }}
          </span>
        </div>
      </div>

      <!-- La pregunta -->
      <div class="question-text">
        <h2 tabindex="-1" #questionTitle id="question-title">{{ currentQuestion.question }}</h2>
        <div class="question-time">
          Tiempo estimado: {{ currentQuestion.estimatedTime }}s
        </div>
        <div class="question-hint">Responde con normalidad. No hay respuestas correctas o incorrectas.</div>
        <!-- Pill de feedback inmediato para la √∫ltima respuesta registrada -->
        <div class="pill-feedback" *ngIf="questionPills.length > 0">
          <ng-container *ngIf="questionPills[questionPills.length - 1] as pill">
            <span class="pill" [class.clear]="pill.status==='clear'" [class.review]="pill.status==='review'" [class.evasive]="pill.status==='evasive'">
              {{ pill.label }}
            </span>
            <span class="pill-reason">{{ pill.reason }}</span>
          </ng-container>
        </div>
      </div>

      <!-- √Årea de respuesta -->
      <div class="response-area" [attr.aria-busy]="isProcessingResponse">
        <!-- Estados accesibles -->
        <div class="state-announcer" aria-live="polite">
          <span class="badge idle" *ngIf="!isRecording && !isProcessingResponse && !lastSavedAt">Listo para grabar</span>
          <span class="badge recording" *ngIf="isRecording">Grabando‚Ä¶ ({{ formatTimeMMSS(recordingSeconds) }})</span>
          <span class="badge processing" *ngIf="isProcessingResponse">Procesando respuesta‚Ä¶</span>
          <span class="badge saved" *ngIf="!isRecording && !isProcessingResponse && lastSavedAt">Guardado ‚úì</span>
        </div>
        <div class="input-container">
          <textarea 
            [(ngModel)]="currentResponse"
            placeholder="Escriba su respuesta aqu√≠..."
            class="response-input"
            [disabled]="isProcessingResponse"
            rows="4">
          </textarea>
          
          <!-- Controles de voz -->
          <div class="voice-controls">
            <button 
              class="voice-btn"
              [class.recording]="isRecording"
              (click)="toggleRecording()"
              [disabled]="isRecording || isProcessingResponse"
              aria-label="Grabar"
              title="Grabar"
              (keydown.enter)="$event.preventDefault(); toggleRecording()"
              (keydown.space)="$event.preventDefault(); toggleRecording()">
              <span class="voice-icon">üé§</span>
              Grabar
            </button>
            <button 
              class="voice-btn stop"
              *ngIf="isRecording"
              (click)="toggleRecording()"
              aria-label="Detener"
              title="Detener"
              (keydown.enter)="$event.preventDefault(); toggleRecording()"
              (keydown.space)="$event.preventDefault(); toggleRecording()">
              <span class="voice-icon">üî¥</span>
              Detener
            </button>
          </div>
        </div>

        <!-- Indicadores de estr√©s en tiempo real -->
        <div class="stress-indicators" *ngIf="stressIndicators | async as indicators">
          <div class="indicator-list" *ngIf="indicators.length > 0">
            <span class="indicator-label">Detectado:</span>
            <span class="indicator" *ngFor="let indicator of indicators">{{ indicator }}</span>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
          <button 
            class="skip-btn" 
            (click)="skipQuestion()"
            *ngIf="currentQuestion.weight <= 4"
            [disabled]="isProcessingResponse">
            Saltar
          </button>
          
          <button 
            class="submit-btn"
            *ngIf="hasResultReady"
            (click)="submitResponse()"
            [disabled]="isProcessingResponse"
            aria-label="Siguiente"
            title="Siguiente">
            Siguiente
          </button>
        </div>

        <!-- Overlay de procesamiento -->
        <div class="processing-overlay" *ngIf="isProcessingResponse">
          <div class="processing-content">Procesando respuesta‚Ä¶</div>
        </div>

        <!-- Preguntas de seguimiento (si las hay) -->
        <div class="follow-up-questions" *ngIf="currentQuestion.followUpQuestions && currentQuestion.followUpQuestions.length > 0">
          <div class="follow-up-header">Preguntas de seguimiento sugeridas:</div>
          <ul class="follow-up-list">
            <li *ngFor="let followUp of currentQuestion.followUpQuestions">{{ followUp }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Estado: Analizando -->
  <div class="analyzing-state" *ngIf="isAnalyzing">
    <section class="ui-card">
      <h2 class="text-sm font-semibold mb-3 text-slate-900 dark:text-slate-100">Resultado AVI</h2>

      <!-- Skeleton Loader -->
      <div class="animate-pulse space-y-3">
        <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded"></div>
        <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded"></div>
        <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4"></div>
      </div>

      <p class="text-sm text-slate-600 dark:text-slate-400 mt-3">Analizando respuestas...</p>
    </section>
  </div>

  <!-- Estado: Resultados -->
  <div class="results-state" *ngIf="showResults && dualEngineResult">
    <div class="results-container">
      <!-- Resultado AVI Minimalista -->
      <section class="ui-card">
        <h2 class="text-sm font-semibold mb-3 text-slate-900 dark:text-slate-100">Resultado AVI</h2>

        <!-- Loader -->
        <div *ngIf="isAnalyzing" class="animate-pulse space-y-3">
          <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded"></div>
          <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded"></div>
        </div>

        <!-- Resultados -->
        <div *ngIf="!isAnalyzing">
          <div class="text-2xl font-semibold mb-2 text-slate-900 dark:text-slate-100" data-cy="avi-decision">
            {{ finalDecision }}
          </div>
          <ul class="list-disc pl-4 space-y-1" *ngIf="finalFlags.length > 0">
            <li *ngFor="let flag of finalFlags" class="text-sm text-slate-500 dark:text-slate-400" data-cy="avi-flag">
              {{ flag }}
            </li>
          </ul>
        </div>
      </section>
      
      <!-- Score principal -->
      <div class="main-score-card">
        <div class="score-header">
          <h1>Score Final</h1>
          <div class="consensus-level" [class]="dualEngineResult.consensus.level.toLowerCase()">
            Consenso: {{ dualEngineResult.consensus.level }}
          </div>
        </div>
        
        <div class="score-display">
          <div class="consolidated-score" [class]="getRiskLevelClass()">
            <span class="score-number">{{ dualEngineResult.consolidatedScore.totalScore }}</span>
            <span class="score-label">/ 1000</span>
          </div>
          <div class="risk-level" [class]="getRiskLevelClass()">
            {{ dualEngineResult.consolidatedScore.riskLevel }}
          </div>
        </div>
      </div>

      <!-- Comparaci√≥n de engines -->
      <div class="engines-comparison">
        <div class="engine-result">
          <h3>üî¨ Engine Cient√≠fico</h3>
          <div class="engine-score">{{ dualEngineResult.scientificScore.totalScore }}</div>
          <div class="engine-risk">{{ dualEngineResult.scientificScore.riskLevel }}</div>
          <div class="engine-time">{{ dualEngineResult.scientificScore.processingTime }}ms</div>
          
          <div class="engine-advantages">
            <div class="advantages-title">Ventajas:</div>
            <ul>
              <li *ngFor="let advantage of dualEngineResult.consensus.scientificAdvantages">
                {{ advantage }}
              </li>
            </ul>
          </div>
        </div>

        <div class="engine-result">
          <h3>üéØ Engine Heur√≠stico</h3>
          <div class="engine-score">{{ dualEngineResult.heuristicScore.totalScore }}</div>
          <div class="engine-risk">{{ dualEngineResult.heuristicScore.riskLevel }}</div>
          <div class="engine-time">{{ dualEngineResult.heuristicScore.processingTime }}ms</div>
          
          <div class="engine-advantages">
            <div class="advantages-title">Ventajas:</div>
            <ul>
              <li *ngFor="let advantage of dualEngineResult.consensus.heuristicAdvantages">
                {{ advantage }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Consenso y an√°lisis -->
      <div class="consensus-analysis">
        <h3>An√°lisis de Consenso</h3>
        <div class="consensus-info">
          <div class="consensus-item">
            <span class="label">Diferencia de Score:</span>
            <span class="value">{{ dualEngineResult.consensus.scoreDifference }} puntos</span>
          </div>
          <div class="consensus-item">
            <span class="label">Acuerdo en Risk Level:</span>
            <span class="value" [class.positive]="dualEngineResult.consensus.riskLevelAgreement">
              {{ dualEngineResult.consensus.riskLevelAgreement ? 'S√≠' : 'No' }}
            </span>
          </div>
          <div class="consensus-description">
            {{ dualEngineResult.consensus.agreement }}
          </div>
        </div>
      </div>

      <!-- Red Flags -->
      <div class="red-flags-section" *ngIf="dualEngineResult.consolidatedScore.redFlags.length > 0">
        <h3>üö® Red Flags Detectadas</h3>
        <div class="red-flags-list">
          <div 
            class="red-flag-item" 
            *ngFor="let flag of dualEngineResult.consolidatedScore.redFlags"
            [class]="flag.severity.toLowerCase()">
            <div class="flag-header">
              <span class="flag-severity">{{ flag.severity }}</span>
              <span class="flag-impact">Impacto: {{ flag.impact }}/10</span>
            </div>
            <div class="flag-reason">{{ flag.reason }}</div>
            <div class="flag-question">Pregunta: {{ flag.questionId }}</div>
          </div>
        </div>
      </div>

      <!-- Category Scores -->
      <div class="category-scores">
        <h3>Scores por Categor√≠a</h3>
        <div class="categories-grid">
          <div 
            class="category-item" 
            *ngFor="let entry of getCategoryScoreEntries()">
            <div class="category-name">{{ entry.category }}</div>
            <div class="category-score">{{ entry.score }}</div>
          </div>
        </div>
      </div>

      <!-- Recomendaciones -->
      <div class="recommendations-section">
        <h3>Recomendaciones del Sistema</h3>
        <div class="recommendations-list">
          <div 
            class="recommendation-item" 
            *ngFor="let recommendation of dualEngineResult.recommendations">
            {{ recommendation }}
          </div>
        </div>
      </div>

      <!-- M√©tricas t√©cnicas -->
      <div class="technical-metrics">
        <h3>M√©tricas T√©cnicas</h3>
        <div class="metrics-grid">
          <div class="metric">
            <span class="metric-label">Tiempo Total:</span>
            <span class="metric-value">{{ formatTime(dualEngineResult.processingTime) }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad Cient√≠fica:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.scientific * 100).toFixed(1) }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad Heur√≠stica:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.heuristic * 100).toFixed(1) }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confiabilidad General:</span>
            <span class="metric-value">{{ (dualEngineResult.engineReliability.overall * 100).toFixed(1) }}%</span>
          </div>
        </div>
      </div>

      <!-- Botones de acci√≥n final -->
      <div class="final-actions">
        <button class="restart-btn" (click)="restartInterview()">
          Nueva Entrevista
        </button>
        <button class="export-btn" disabled>
          Exportar Reporte
        </button>
      </div>
    </div>
  </div>

</div>
