<!-- Skip Link for Accessibility -->
<a class="skip-link" href="#main-content">Saltar al contenido principal</a>

<div class="proteccion-shell">
  <header class="proteccion-header">
    <div class="proteccion-header__inner">
      <div class="proteccion-header__info">
        <h1 class="proteccion-title">Sistema de Protección</h1>
        <p class="proteccion-subtitle">Análisis de riesgo y protección financiera para transportistas</p>
      </div>
    </div>
  </header>

  <main id="main-content" class="proteccion-main">
    <app-offline-queue-banner
      contextLabel="protecciones"
      endpointPrefix="/protection"
      featureTag="proteccion"
    ></app-offline-queue-banner>
    <app-context-panel
      class="proteccion-context-panel"
      [keys]="['proteccion', 'cotizador', 'documentos', 'onboarding-wizard']">
    </app-context-panel>
    <!-- Protección KPIs -->
    <section class="card proteccion-section">
      <h2 class="section-heading">Protección</h2>

      <!-- Skeleton Loader -->
      <div *ngIf="loading" class="proteccion-skeleton">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
      </div>

      <!-- KPI Cards -->
      <div *ngIf="!loading" class="proteccion-kpi-grid">
        <div class="card proteccion-metric-card" data-cy="health-score-card">
          <div class="proteccion-metric-label">Health Score</div>
          <div class="proteccion-metric-value" data-cy="health-score">{{ healthScore }}</div>
        </div>
        <div class="card proteccion-metric-card" data-cy="coverage-card">
          <div class="proteccion-metric-label">Cobertura</div>
          <div class="proteccion-metric-value" data-cy="coverage">{{ cobertura }}</div>
        </div>
        <div class="card proteccion-apply-card">
          <button
            data-cy="apply-protection"
            (click)="aplicarProteccion()"
            [disabled]="loading"
            class="btn btn-primary proteccion-apply-button">
            {{ loading ? 'Aplicando...' : 'Aplicar' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Análisis de Riesgo -->
    <section class="card proteccion-section">
      <h3 class="section-heading">Análisis de Riesgo</h3>
      <div class="risk-grid">
        <div class="risk-card risk-card--high">
          <div class="risk-card__value">{{ highRiskClients }}</div>
          <div class="risk-card__label">Alto Riesgo</div>
          <div class="risk-card__hint">Atención inmediata</div>
        </div>
        <div class="risk-card risk-card--medium">
          <div class="risk-card__value">{{ mediumRiskClients }}</div>
          <div class="risk-card__label">Riesgo Medio</div>
          <div class="risk-card__hint">Monitoreo recomendado</div>
        </div>
        <div class="risk-card risk-card--low">
          <div class="risk-card__value">{{ lowRiskClients }}</div>
          <div class="risk-card__label">Bajo Riesgo</div>
          <div class="risk-card__hint">Situación estable</div>
        </div>
      </div>
    @if (riskEvaluation()) {
      <section class="card proteccion-section">
        <app-risk-panel
          [riskEvaluation]="riskEvaluation"
          [isLoading]="riskLoading"
          [hasError]="riskError"
        ></app-risk-panel>
      </section>
    }

    </section>

    <!-- Herramientas -->
    <section class="card proteccion-section">
      <h3 class="section-heading">Herramientas de Protección</h3>
      <div class="protection-tools__grid">
        <button class="btn btn-ghost protection-tools__button" (click)="openTool('savings')">
          <app-icon name="calculator" [size]="24" class="protection-tools__icon" />
          Simulador de Ahorro
        </button>
        <button class="btn btn-ghost protection-tools__button" (click)="openTool('cashflow')">
          <app-icon name="chart" [size]="24" class="protection-tools__icon" />
          Gestión de Cashflow
        </button>
        <button class="btn btn-ghost protection-tools__button" (click)="openTool('contingency')">
          <app-icon name="information-circle" [size]="24" class="protection-tools__icon" />
          Plan de Contingencia
        </button>
        <button class="btn btn-ghost protection-tools__button" (click)="openTool('report')">
          <app-icon name="document-report" [size]="24" class="protection-tools__icon" />
          Reporte Ejecutivo
        </button>
        <button class="btn btn-ghost protection-tools__button" (click)="generateProtectionReport()">
          <app-icon name="shield" [size]="24" class="protection-tools__icon" />
          Generar Protección
        </button>
      </div>
    </section>

    <!-- Escenarios de Reestructura -->
    <section class="card proteccion-section" *ngIf="scenarios && scenarios.length">
      <h3 class="section-heading">Escenarios de Reestructura</h3>
      <div class="scenario-list">
        <div
          *ngFor="let s of scenarios"
          class="scenario-card"
          [class.scenario-card--eligible]="isScenarioEligible(s)"
          [class.scenario-card--ineligible]="!isScenarioEligible(s)">
          <div class="scenario-card__header">
            <div>
              <h4 class="scenario-card__title">{{ s.title }}</h4>
              <span class="scenario-card__badge"
                    [class.scenario-card__badge--eligible]="isScenarioEligible(s)"
                    [class.scenario-card__badge--ineligible]="!isScenarioEligible(s)">
                {{ isScenarioEligible(s) ? 'Elegible' : 'No elegible' }}
              </span>
            </div>
            <!-- <span class="scenario-card__score">{{ s.score }}%</span> -->
          </div>

          <div class="scenario-summary">
            <div>
              <div class="scenario-summary__label">PMT′</div>
              <div class="scenario-summary__value">{{ formatCurrency(getNewMonthlyPayment(s)) }}</div>
            </div>
            <div>
              <div class="scenario-summary__label">n′</div>
              <div class="scenario-summary__value">{{ getNewTerm(s) }} meses</div>
            </div>
            <div>
              <div class="scenario-summary__label">TIR post</div>
              <div
                class="scenario-summary__value"
                [class.scenario-summary__value--ok]="isTirOk(s)"
                [class.scenario-summary__value--alert]="!isTirOk(s)">
                {{ getIrrPct(s) | number:'1.0-2' }}%
              </div>
            </div>
          </div>

          <div *ngIf="hasRejectionReasons(s)" class="scenario-warning">
            <div *ngIf="!isTirOk(s)">Motivo: IRRpost &lt; IRRmin</div>
            <div *ngIf="isBelowMinPayment(s)">Motivo: PMT′ &lt; PMTmin</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Configuración de Contrato -->
    <section class="card proteccion-section">
      <h3 class="section-heading">Configuración de Contrato</h3>
      <form [formGroup]="contractForm" class="proteccion-form">
        <div class="proteccion-form__grid">
          <label class="proteccion-form__label">
            Saldo Actual
            <input
              type="number"
              formControlName="currentBalance"
              placeholder="320000"
              class="input proteccion-form__input">
          </label>
          <label class="proteccion-form__label">
            Pago Mensual Actual (PMT)
            <input
              type="number"
              formControlName="originalPayment"
              placeholder="10500"
              class="input proteccion-form__input">
          </label>
          <label class="proteccion-form__label">
            Plazo Remanente (meses)
            <input
              type="number"
              formControlName="remainingTerm"
              placeholder="36"
              class="input proteccion-form__input">
          </label>
          <label class="proteccion-form__label">
            Mercado
            <select
              formControlName="market"
              class="input proteccion-form__input">
              <option value="aguascalientes">Aguascalientes</option>
              <option value="edomex">Estado de México</option>
            </select>
          </label>
        </div>
        <div class="proteccion-form__actions">
          <button
            type="button"
            class="btn btn-primary"
            (click)="computeScenarios()"
            [disabled]="!contractForm.valid">
            Calcular Escenarios
          </button>
        </div>
      </form>
    </section>
  </main>
</div>
