<a class="skip-link" href="#main-content">Saltar al contenido principal</a>

<div class="tanda-colectiva">
  <header class="tanda-colectiva__header">
    <div class="tanda-colectiva__header-inner">
      <button class="btn btn-ghost btn-sm" type="button" (click)="goBack()" data-cy="back-button">
        ← Volver
      </button>
      <div class="tanda-colectiva__title-group">
        <h1 class="tanda-colectiva__title">Simulador de Tanda Colectiva</h1>
        <p class="tanda-colectiva__subtitle">Estrategia de ahorro grupal para vagonetas EdoMex</p>
      </div>
    </div>
  </header>

  <main id="main-content" class="tanda-colectiva__main">
    <section class="card tanda-colectiva__kpi" *ngIf="simulationResult?.scenario">
      <div class="tanda-colectiva__kpi-grid">
        <div class="tanda-colectiva__kpi-item" data-cy="group-monthly">
          <p class="tanda-colectiva__kpi-label" data-cy="group-monthly-label">Aportación Mensual (Grupo)</p>
          <p class="tanda-colectiva__kpi-value">{{ formatCurrency(simulationResult?.scenario?.monthlyContribution || 0) }}</p>
        </div>
        <div class="tanda-colectiva__kpi-item" data-cy="first-award">
          <p class="tanda-colectiva__kpi-label" data-cy="first-award-label">1er Otorgamiento</p>
          <p class="tanda-colectiva__kpi-value">{{ simulationResult?.scenario?.monthsToFirstAward || 0 }} meses</p>
        </div>
        <div class="tanda-colectiva__kpi-item" data-cy="full-delivery">
          <p class="tanda-colectiva__kpi-label" data-cy="full-delivery-label">Entrega Completa</p>
          <p class="tanda-colectiva__kpi-value">{{ simulationResult?.scenario?.monthsToFullDelivery || 0 }} meses</p>
        </div>
      </div>
    </section>

    <div class="tanda-colectiva__content">
      <section class="card tanda-colectiva__panel" data-cy="edomex-colectivo-panel">
        <h2 class="tanda-colectiva__section-title">EdoMex Colectivo – Parámetros</h2>

        <form [formGroup]="configForm" class="tanda-colectiva__form">
          <div class="tanda-colectiva__form-grid">
            <label class="tanda-colectiva__field">
              <span class="tanda-colectiva__field-label">Miembros (n)</span>
              <input
                class="tanda-colectiva__input"
                data-cy="members"
                type="number"
                formControlName="memberCount"
                placeholder="15"
              >
            </label>

            <label class="tanda-colectiva__field">
              <span class="tanda-colectiva__field-label">Valor Unidad (MXN)</span>
              <input
                class="tanda-colectiva__input"
                data-cy="unit-price"
                type="number"
                formControlName="unitPrice"
                placeholder="800000"
              >
            </label>

            <label class="tanda-colectiva__field">
              <span class="tanda-colectiva__field-label">Consumo Promedio /Miembro (L)</span>
              <input
                class="tanda-colectiva__input"
                data-cy="avg-consumption"
                type="number"
                formControlName="avgConsumption"
                placeholder="500"
              >
            </label>

            <label class="tanda-colectiva__field">
              <span class="tanda-colectiva__field-label">Sobreprecio por Litro (MXN)</span>
              <input
                class="tanda-colectiva__input"
                data-cy="overprice-lit"
                type="number"
                step="0.01"
                formControlName="overpricePerLiter"
                placeholder="2.50"
              >
            </label>

            <label class="tanda-colectiva__field">
              <span class="tanda-colectiva__field-label">Aportación Voluntaria /Miembro (MXN)</span>
              <input
                class="tanda-colectiva__input"
                data-cy="voluntary-member"
                type="number"
                formControlName="voluntaryMonthly"
                placeholder="0"
              >
            </label>
          </div>

          <div class="tanda-colectiva__form-actions">
            <button
              class="btn btn-primary"
              type="button"
              (click)="simulateTanda()"
              [disabled]="!configForm.valid || isSimulating"
              data-cy="run-edomex-colectivo"
            >
              {{ isSimulating ? 'Simulando...' : 'Simular' }}
            </button>
          </div>
        </form>
      </section>

      <section class="card tanda-colectiva__panel" data-cy="edomex-colectivo-results" *ngIf="simulationResult?.scenario">
        <h3 class="tanda-colectiva__section-title">Resultado – EdoMex Colectivo</h3>

        <div class="tanda-colectiva__chart-grid">
          <div class="card tanda-colectiva__chart-card">
            <h4 class="tanda-colectiva__chart-title">Ahorro acumulado (grupo)</h4>
            <canvas id="chartAhorroCol" data-cy="chart-ahorro-col" #groupSavingsChart></canvas>
          </div>
          <div class="card tanda-colectiva__chart-card">
            <h4 class="tanda-colectiva__chart-title">PMT promedio</h4>
            <canvas id="chartPMTCol" data-cy="chart-pmt-col" #avgPmtChart></canvas>
          </div>
        </div>

        <div class="card tanda-colectiva__comparison">
          <h4 class="tanda-colectiva__chart-title">Comparación de Simulaciones</h4>
          <table class="tanda-colectiva__table" data-cy="sim-comparison-table">
            <thead>
              <tr>
                <th>Escenario</th>
                <th>Ahorro/Grupo</th>
                <th>PMT Promedio</th>
                <th>1er Otorg.</th>
                <th>Entrega Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Escenario Actual</td>
                <td>{{ formatCurrency(simulationResult?.scenario?.monthlyContribution || 0) }}</td>
                <td>{{ formatCurrency((simulationResult?.scenario?.monthlyContribution || 0) / (configForm.get('memberCount')?.value || 1)) }}</td>
                <td>{{ simulationResult?.scenario?.monthsToFirstAward || 0 }} m</td>
                <td>{{ simulationResult?.scenario?.monthsToFullDelivery || 0 }} m</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="tanda-colectiva__actions">
          <button class="btn btn-primary" type="button" (click)="generatePDF()">
            <span class="btn-icon" aria-hidden="true">
              <app-icon name="document-text" [size]="16" />
            </span>
            PDF
          </button>
          <button class="btn btn-secondary" type="button" (click)="resetForm()">
            <span class="btn-icon" aria-hidden="true">
              <app-icon name="refresh" [size]="16" />
            </span>
            Limpiar
          </button>
        </div>
      </section>
    </div>
  </main>
</div>
