<div class="ops-deliveries command-container">
      <!-- Header (compact) -->
      <div class="ops-deliveries__header">
        <div class="ops-deliveries__header-content">
          <h1 class="ops-deliveries__title">Entregas</h1>
          <p class="ops-deliveries__subtitle">Órdenes y stock por mercado</p>
        </div>
        <div class="ops-deliveries__header-actions">
          <button class="ops-deliveries__action-button ops-deliveries__action-button--refresh" (click)="refreshData()" [disabled]="loading()" aria-label="Actualizar">
            <app-icon [name]="loading() ? 'clock' : 'refresh'" [size]="16" class="ops-deliveries__action-icon" />
            Actualizar
          </button>
          <button class="ops-deliveries__action-button ops-deliveries__action-button--recompute" (click)="recomputeStock()" [disabled]="stockLoading()" aria-label="Recalcular stock">
            <app-icon name="chart" [size]="16" class="ops-deliveries__action-icon" />
            Recalcular Stock
          </button>
        </div>
      </div>

    <app-context-panel
      class="ops-deliveries__context-panel"
      [keys]="['entregas', 'documentos', 'cotizador']">
    </app-context-panel>

    <app-delivery-tracker
      class="ops-deliveries__tracker"
      [market]="trackerMarket">
    </app-delivery-tracker>

    <section class="ops-deliveries__metrics" aria-label="Indicadores de desempeño">
      <div *ngIf="metricsLoading()" class="ops-deliveries__metrics-loading">Cargando indicadores de entrega…</div>
      <div *ngIf="!metricsLoading() && performanceMetrics() as metrics" class="ops-deliveries__summary-grid">
        <div class="ops-deliveries__summary-card">
          <h4>Total de pedidos</h4>
          <div class="ops-deliveries__summary-stats">
            <div class="ops-deliveries__summary-stat">
              <span class="ops-deliveries__summary-value">{{ metrics.totalDeliveries }}</span>
              <span class="ops-deliveries__summary-label">Registrados en NEON</span>
            </div>
          </div>
        </div>
        <div class="ops-deliveries__summary-card">
          <h4>Entregas a tiempo</h4>
          <div class="ops-deliveries__summary-stats">
            <div class="ops-deliveries__summary-stat">
              <span class="ops-deliveries__summary-value">{{ metrics.onTimePercentage }}%</span>
              <span class="ops-deliveries__summary-label">Cumplimiento ETA</span>
            </div>
          </div>
        </div>
        <div class="ops-deliveries__summary-card">
          <h4>Promedio tránsito</h4>
          <div class="ops-deliveries__summary-stats">
            <div class="ops-deliveries__summary-stat">
              <span class="ops-deliveries__summary-value">{{ metrics.avgTransitDays }} días</span>
              <span class="ops-deliveries__summary-label">Del pedido a entrega</span>
            </div>
          </div>
        </div>
        <div class="ops-deliveries__summary-card">
          <h4>Pedidos retrasados</h4>
          <div class="ops-deliveries__summary-stats">
            <div class="ops-deliveries__summary-stat">
              <span class="ops-deliveries__summary-value">{{ metrics.delayedDeliveries }}</span>
              <span class="ops-deliveries__summary-label">Requieren seguimiento</span>
      </div>
    </div>
  </div>

  <!-- Modal Historial ETA -->
  <div *ngIf="showEtaHistoryModal()" class="ops-deliveries__modal-overlay" (click)="closeEtaHistory()">
    <div class="ops-deliveries__modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="eta-history-title">
      <div class="ops-deliveries__modal-header">
        <h3 id="eta-history-title">Historial ETA – {{ etaHistoryDelivery()?.client?.name }}</h3>
        <button class="ops-deliveries__modal-close" type="button" (click)="closeEtaHistory()" aria-label="Cerrar">
          <app-icon name="x" [size]="16"></app-icon>
        </button>
      </div>
      <div class="ops-deliveries__modal-body">
        <div *ngIf="etaHistoryLoading()" class="ops-deliveries__metrics-loading">Cargando historial…</div>
        <div *ngIf="etaHistoryError()" class="ops-deliveries__alert ops-deliveries__alert--warning">{{ etaHistoryError() }}</div>
        <table *ngIf="!etaHistoryLoading() && !etaHistoryError() && etaHistory().length" class="ops-deliveries__table eta-history-table">
          <thead>
            <tr>
              <th>Registrado</th>
              <th>ETA anterior</th>
              <th>ETA nueva</th>
              <th>Método</th>
              <th>Motivo</th>
              <th>Registrado por</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of etaHistory()">
              <td>{{ formatEtaHistoryDate(entry.calculatedAt || entry.createdAt) }}</td>
              <td>{{ formatETA(entry.previousEta) }}</td>
              <td>{{ formatETA(entry.newEta) }}</td>
              <td>{{ entry.method || 'Automático' }}</td>
              <td>{{ entry.reason || '—' }}</td>
              <td>{{ entry.adjustedBy || 'NEON' }}</td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="!etaHistoryLoading() && !etaHistoryError() && !etaHistory().length" class="ops-deliveries__empty-state">Sin ajustes de ETA registrados.</p>
      </div>
      <div class="ops-deliveries__modal-footer">
        <button type="button" class="ops-deliveries__button ops-deliveries__button--view" (click)="closeEtaHistory()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ajustar ETA -->
  <div *ngIf="showAdjustEtaModal()" class="ops-deliveries__modal-overlay" (click)="closeAdjustEtaModal()">
    <div class="ops-deliveries__modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="adjust-eta-title">
      <div class="ops-deliveries__modal-header">
        <h3 id="adjust-eta-title">Ajustar ETA – {{ adjustEtaDelivery()?.client?.name }}</h3>
        <button class="ops-deliveries__modal-close" type="button" (click)="closeAdjustEtaModal()" aria-label="Cerrar">
          <app-icon name="x" [size]="16"></app-icon>
        </button>
      </div>
      <div class="ops-deliveries__modal-body">
        <label class="ops-deliveries__filters-label">
          Nueva fecha estimada
          <input
            type="date"
            [ngModel]="adjustEtaDate()"
            (ngModelChange)="adjustEtaDate.set($event)"
            class="ops-deliveries__filters-input"
            name="adjustEtaDate">
        </label>
        <label class="ops-deliveries__filters-label">
          Motivo del ajuste
          <textarea
            rows="3"
            [ngModel]="adjustEtaReason()"
            (ngModelChange)="adjustEtaReason.set($event)"
            class="ops-deliveries__textarea"
            name="adjustEtaReason"
            placeholder="Ej. Retraso en aduana">
          </textarea>
        </label>
        <div *ngIf="adjustEtaError()" class="ops-deliveries__alert ops-deliveries__alert--warning">{{ adjustEtaError() }}</div>
      </div>
      <div class="ops-deliveries__modal-footer">
        <button type="button" class="ops-deliveries__button ops-deliveries__button--cancel" (click)="closeAdjustEtaModal()" [disabled]="adjustEtaSaving()">Cancelar</button>
        <button type="button" class="ops-deliveries__button ops-deliveries__button--advance" (click)="submitEtaAdjustment()" [disabled]="adjustEtaSaving()">
          {{ adjustEtaSaving() ? 'Guardando…' : 'Guardar ETA' }}
        </button>
      </div>
    </div>
  </div>
</div>
    </section>

      <!-- Filtros Jerárquicos: Mercado > Ruta > Cliente > Pedido -->
      <div class="ops-deliveries__filters" role="region" aria-label="Filtros de entregas">
        <div class="ops-deliveries__filters-item">
          <label class="ops-deliveries__filters-label">
            <app-icon name="location-marker" [size]="16" class="ops-deliveries__filter-icon" />
            Mercado
          </label>
          <select [(ngModel)]="selectedMarket" (change)="onMarketChange()" class="ops-deliveries__filters-select" aria-label="Seleccionar mercado">
            <option value="">Todos los mercados</option>
            <option value="aguascalientes">Aguascalientes (CON asientos)</option>
            <option value="edomex">Estado de México (SIN asientos)</option>
          </select>
        </div>

        <div class="ops-deliveries__filters-item" *ngIf="selectedMarket() === 'edomex'">
          <label class="ops-deliveries__filters-label">
            <app-icon name="map" [size]="16" class="ops-deliveries__filter-icon" />
            Ruta
          </label>
          <select [(ngModel)]="selectedRoute" (change)="onRouteChange()" class="ops-deliveries__filters-select" aria-label="Seleccionar ruta">
            <option value="">Todas las rutas</option>
            <option *ngFor="let route of availableRoutes()" [value]="route.id">
              {{ route.name }}
            </option>
          </select>
        </div>

        <div class="ops-deliveries__filters-item">
          <label class="ops-deliveries__filters-label">
            <app-icon name="user" [size]="16" class="ops-deliveries__filter-icon" />
            Cliente
          </label>
          <input 
            type="text" 
            [(ngModel)]="clientSearch" 
            (input)="onClientSearch()"
            placeholder="Buscar por nombre de cliente..."
            class="ops-deliveries__filters-input"
            aria-label="Buscar cliente">
        </div>

        <div class="ops-deliveries__filters-item">
          <label class="ops-deliveries__filters-label">
            <app-icon name="package" [size]="16" class="ops-deliveries__filter-icon" />
            Estado
          </label>
          <select [(ngModel)]="selectedStatus" (change)="onStatusChange()" class="ops-deliveries__filters-select" aria-label="Seleccionar estado">
            <option value="">Todos los estados</option>
            <option *ngFor="let status of deliveryStatuses" [value]="status">
              {{ getStatusTitle(status) }}
            </option>
          </select>
        </div>

        <div class="ops-deliveries__filters-summary">
          <span class="ops-deliveries__results">
            {{ filteredDeliveries().length }} pedido{{ filteredDeliveries().length !== 1 ? 's' : '' }} encontrado{{ filteredDeliveries().length !== 1 ? 's' : '' }}
          </span>
          <button *ngIf="hasActiveFilters()" class="ops-deliveries__clear-button" (click)="clearFilters()" aria-label="Limpiar filtros activos">
            <app-icon name="trash" [size]="16" class="ops-deliveries__action-icon" />
            Limpiar filtros
          </button>
        </div>
      </div>

      <!-- Vista por Mercado (Stock + Resumen) -->
      <div *ngIf="currentView() === 'market'" class="ops-deliveries__panel ops-deliveries__panel--market">
        <div class="ops-deliveries__stock-grid">
          <div class="ops-deliveries__stock-card" *ngFor="let position of stockPositions()">
            <div class="ops-deliveries__stock-card-header">
              <h3>{{ getMarketName(position.market) }}</h3>
              <span class="ops-deliveries__sku-badge">{{ position.sku }}</span>
            </div>
            <div class="ops-deliveries__stock-metrics">
              <div class="ops-deliveries__metric">
                <span class="ops-deliveries__metric-label">En stock</span>
                <span class="ops-deliveries__metric-value" [ngClass]="{ 'ops-deliveries__metric-value--low': position.onHand < position.reorderPoint }">
                  {{ position.onHand }}
                </span>
              </div>
              <div class="ops-deliveries__metric">
                <span class="ops-deliveries__metric-label">En tránsito</span>
                <span class="ops-deliveries__metric-value">{{ position.onOrder }}</span>
              </div>
              <div class="ops-deliveries__metric">
                <span class="ops-deliveries__metric-label">Proyección</span>
                <span class="ops-deliveries__metric-value">{{ position.forecast }}</span>
              </div>
            </div>
            <div class="ops-deliveries__alerts" *ngIf="getMarketAlerts(position.market).length > 0">
              <div *ngFor="let alert of getMarketAlerts(position.market)" class="ops-deliveries__alert" [ngClass]="'ops-deliveries__alert--' + alert.severity">
                {{ alert.message }}
              </div>
            </div>
          </div>
        </div>

        <div class="ops-deliveries__market-summary">
          <h3>
            <app-icon name="chart" [size]="20" class="ops-deliveries__section-icon" />
            Resumen de Entregas por Mercado
          </h3>
          <div class="ops-deliveries__summary-grid">
            <div class="ops-deliveries__summary-card" *ngFor="let summary of marketSummary()">
              <h4>{{ getMarketName(summary.market) }}</h4>
              <div class="ops-deliveries__summary-stats">
                <div class="ops-deliveries__summary-stat">
                  <span class="ops-deliveries__summary-value">{{ summary.total }}</span>
                  <span class="ops-deliveries__summary-label">Total pedidos</span>
                </div>
                <div class="ops-deliveries__summary-stat">
                  <span class="ops-deliveries__summary-value">{{ summary.inTransit }}</span>
                  <span class="ops-deliveries__summary-label">En tránsito</span>
                </div>
                <div class="ops-deliveries__summary-stat">
                  <span class="ops-deliveries__summary-value">{{ summary.readyForDelivery }}</span>
                  <span class="ops-deliveries__summary-label">Listas para entrega</span>
                </div>
                <div class="ops-deliveries__summary-stat">
                  <span class="ops-deliveries__summary-value">{{ summary.delivered }}</span>
                  <span class="ops-deliveries__summary-label">Entregadas</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista por Ruta (Solo EdoMex) -->
      <div *ngIf="currentView() === 'route'" class="ops-deliveries__panel ops-deliveries__panel--route">
        <h3>
          <app-icon name="map" [size]="20" class="ops-deliveries__section-icon" />
          Entregas por Ruta - {{ getSelectedRouteName() }}
        </h3>
        <div class="ops-deliveries__route">
          <div class="ops-deliveries__table">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Pedido</th>
                  <th>Estado</th>
                  <th>ETA</th>
                  <th>Progreso</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let delivery of filteredDeliveries()" class="ops-deliveries__table-row">
                  <td>
                    <div class="ops-deliveries__client-info">
                      <span class="ops-deliveries__client-name">{{ delivery.client.name }}</span>
                      <span class="ops-deliveries__client-id">{{ delivery.client.id }}</span>
                    </div>
                  </td>
                  <td>
                    <span class="ops-deliveries__order-id">{{ delivery.id }}</span>
                  </td>
                  <td>
                    <span class="ops-deliveries__status-badge" [style.background-color]="getStatusColor(delivery)">
                      <app-icon
                        class="ops-deliveries__status-icon"
                        [name]="getStatusIcon(delivery.status)"
                        [size]="14"
                        aria-hidden="true"
                      ></app-icon>
                      {{ getStatusTitle(delivery.status) }}
                    </span>
                  </td>
                  <td>
                    <span class="ops-deliveries__eta" [ngClass]="{ 'ops-deliveries__eta--overdue': isOverdue(delivery.eta) }">
                      {{ formatETA(delivery.eta) }}
                    </span>
                  </td>
                  <td>
                    <div class="ops-deliveries__progress">
                      <div class="ops-deliveries__progress-fill" [style.width.%]="getProgress(delivery.status)"></div>
                      <span class="ops-deliveries__progress-text">{{ getProgress(delivery.status) }}%</span>
                    </div>
                  </td>
                  <td>
                    <div class="ops-deliveries__table-actions">
                      <button 
                        class="ops-deliveries__icon-button ops-deliveries__icon-button--view"
                        [routerLink]="['/entregas', delivery.id]"
                        title="Ver detalles" aria-label="Ver detalles">
                        Ver
                      </button>
                      <button 
                        *ngIf="canAdvanceStatus(delivery)"
                        class="ops-deliveries__icon-button ops-deliveries__icon-button--advance"
                        (click)="showAdvanceModal(delivery)"
                        title="Avanzar estado" aria-label="Avanzar estado">
                        Avanzar
                      </button>
                      <button
                        class="ops-deliveries__icon-button ops-deliveries__icon-button--history"
                        (click)="openEtaHistory(delivery)"
                        title="Historial ETA" aria-label="Historial ETA">
                        ETA
                      </button>
                      <button
                        class="ops-deliveries__icon-button ops-deliveries__icon-button--adjust"
                        (click)="openAdjustEta(delivery)"
                        title="Ajustar ETA" aria-label="Ajustar ETA">
                        Ajustar ETA
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Vista por Cliente -->
      <div *ngIf="currentView() === 'client'" class="ops-deliveries__panel ops-deliveries__panel--client">
        <h3>
          <app-icon name="user" [size]="20" class="ops-deliveries__section-icon" />
          Vista por Cliente
        </h3>
        <div class="ops-deliveries__client-groups">
          <div *ngFor="let client of groupedByClient()" class="ops-deliveries__client-group">
            <div class="ops-deliveries__client-header">
              <h4>{{ client.name }}</h4>
              <span class="ops-deliveries__client-meta">{{ client.market }} - {{ client.deliveries.length }} pedido(s)</span>
            </div>
            <div class="ops-deliveries__client-delivery-list">
              <div *ngFor="let delivery of client.deliveries" class="ops-deliveries__client-delivery">
                <div class="ops-deliveries__client-summary">
                  <span class="ops-deliveries__order-id">{{ delivery.id }}</span>
                  <span class="ops-deliveries__status-badge" [style.background-color]="getStatusColor(delivery)">
                    <app-icon
                      class="ops-deliveries__status-icon"
                      [name]="getStatusIcon(delivery.status)"
                      [size]="14"
                      aria-hidden="true"
                    ></app-icon>
                    {{ getStatusTitle(delivery.status) }}
                  </span>
                  <span class="ops-deliveries__eta">{{ formatETA(delivery.eta) }}</span>
                  <button class="ops-deliveries__button ops-deliveries__button--view" [routerLink]="['/entregas', delivery.id]" aria-label="Ver detalles">Ver</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista General (Default) -->
      <div *ngIf="currentView() === 'general'" class="ops-deliveries__panel ops-deliveries__panel--general">
        <div class="ops-deliveries__delivery-grid">
          <div *ngFor="let delivery of paginatedDeliveries()" class="ops-deliveries__delivery-card">
            <div class="ops-deliveries__card-header">
              <div class="ops-deliveries__client-info">
                <h4>{{ delivery.client.name }}</h4>
                <span class="ops-deliveries__market-badge">{{ delivery.market }}</span>
                <span *ngIf="delivery.route" class="ops-deliveries__route-badge">{{ delivery.route.name }}</span>
              </div>
              <div class="ops-deliveries__order-meta">
                <span class="ops-deliveries__order-id">{{ delivery.id }}</span>
                <span class="ops-deliveries__created-date">{{ formatDate(delivery.createdAt) }}</span>
              </div>
            </div>
            
            <div class="ops-deliveries__card-body">
              <div class="ops-deliveries__status-section">
                <span class="ops-deliveries__status-badge" [style.background-color]="getStatusColor(delivery)">
                  <app-icon
                    class="ops-deliveries__status-icon"
                    [name]="getStatusIcon(delivery.status)"
                    [size]="14"
                    aria-hidden="true"
                  ></app-icon>
                  {{ getStatusTitle(delivery.status) }}
                </span>
                <div class="ops-deliveries__progress">
                  <div class="ops-deliveries__progress-fill" [style.width.%]="getProgress(delivery.status)"></div>
                </div>
                <span class="ops-deliveries__progress-text">{{ getProgress(delivery.status) }}% completado</span>
              </div>
              
              <div class="ops-deliveries__eta-section">
                <span class="ops-deliveries__eta-label">ETA:</span>
                <span class="ops-deliveries__eta-value" [ngClass]="{ 'ops-deliveries__eta--overdue': isOverdue(delivery.eta) }">
                  {{ formatETA(delivery.eta) }}
                </span>
              </div>
              
              <div class="ops-deliveries__contract">
                <span class="ops-deliveries__contract-label">Contrato:</span>
                <span class="ops-deliveries__contract-value">{{ delivery.contract.id }}</span>
                <span *ngIf="delivery.contract.amount" class="ops-deliveries__contract-amount">
                  {{ formatCurrency(delivery.contract.amount) }}
                </span>
              </div>
            </div>
            
            <div class="ops-deliveries__card-actions">
              <button 
                class="ops-deliveries__button ops-deliveries__button--view"
                [routerLink]="['/entregas', delivery.id]">
                Ver Detalles
              </button>
              <button 
                *ngIf="canAdvanceStatus(delivery)"
                class="ops-deliveries__button ops-deliveries__button--advance"
                (click)="showAdvanceModal(delivery)">
                Avanzar Estado
              </button>
              <button
                class="ops-deliveries__button ops-deliveries__button--view"
                (click)="openEtaHistory(delivery)">
                Historial ETA
              </button>
              <button
                class="ops-deliveries__button ops-deliveries__button--advance"
                (click)="openAdjustEta(delivery)">
                Ajustar ETA
              </button>
            </div>
          </div>
        </div>

        <!-- Paginación -->
        <div *ngIf="totalDeliveries() > pageSize()" class="ops-deliveries__pagination">
          <button 
            class="ops-deliveries__page-button"
            [disabled]="currentPage() === 1"
            (click)="previousPage()">
            <app-icon name="arrow-left" [size]="14" aria-hidden="true" class="ops-deliveries__page-icon"></app-icon>
            Anterior
          </button>
          <span class="ops-deliveries__page-info">
            Página {{ currentPage() }} de {{ totalPages() }}
          </span>
          <button 
            class="ops-deliveries__page-button"
            [disabled]="currentPage() === totalPages()"
            (click)="nextPage()">
            Siguiente
            <app-icon name="arrow-right" [size]="14" aria-hidden="true" class="ops-deliveries__page-icon"></app-icon>
          </button>
        </div>
      </div>

      <!-- Loading State (placeholder estable) -->
      <section *ngIf="loading()" class="premium-card ops-deliveries__loading" role="status" aria-live="polite" aria-busy="true">
        Cargando entregas...
      </section>

      <!-- Empty State -->
      <section *ngIf="!loading() && filteredDeliveries().length === 0" class="premium-card ops-deliveries__empty" role="status" aria-live="polite">
        0 pedidos — ajusta los filtros para ver resultados.
      </section>

      <!-- Modal para Avanzar Estado -->
      <div *ngIf="showAdvanceStateModal()" class="ops-deliveries__modal-overlay" (click)="hideAdvanceModal()">
        <div class="ops-deliveries__modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="advance-title">
          <h3>Avanzar Estado de Entrega</h3>
          <div *ngIf="selectedDelivery()">
            <p><strong>Pedido:</strong> {{ selectedDelivery()!.id }}</p>
            <p><strong>Cliente:</strong> {{ selectedDelivery()!.client.name }}</p>
            <p><strong>Estado actual:</strong> {{ getStatusTitle(selectedDelivery()!.status) }}</p>
            
            <div class="ops-deliveries__transition-options">
              <div *ngFor="let action of availableActions()" class="ops-deliveries__transition">
                <button 
                  class="ops-deliveries__transition-button"
                  (click)="executeTransition(action.event)">
                  {{ action.label }}
                </button>
                <span class="ops-deliveries__transition-description">{{ action.description }}</span>
              </div>
            </div>
            
            <div class="ops-deliveries__modal-footer">
              <button class="ops-deliveries__button ops-deliveries__button--cancel" (click)="hideAdvanceModal()" aria-label="Cerrar">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  
