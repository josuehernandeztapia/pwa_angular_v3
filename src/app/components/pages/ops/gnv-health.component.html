<section class="card gnv-card">
  <div class="gnv-card__header">
    <h2 class="gnv-title">GNV - Salud de Estaciones</h2>
    <p class="gnv-subtitle">Estado de la ingesta del día anterior por estación</p>
  </div>

  <div class="gnv-upload">
    <div class="gnv-upload__header">
      <h3 class="gnv-upload__title">Carga de Datos CSV</h3>
      <div class="gnv-status-indicator">
        <span
          class="gnv-status-dot"
          [class.gnv-status-dot--success]="uploadStatus === 'success'"
          [class.gnv-status-dot--processing]="uploadStatus === 'processing'"
          [class.gnv-status-dot--idle]="uploadStatus === 'idle'"
          [class.gnv-status-dot--error]="uploadStatus === 'error'"
          [attr.data-cy]="'status-' + uploadStatus"
        ></span>
        <span class="gnv-status-text">{{ getUploadStatusText() }}</span>
      </div>
    </div>

    <div class="gnv-upload__body">
      <label class="btn btn-secondary btn-sm gnv-upload__button">
        <input
          type="file"
          accept=".csv"
          (change)="onFileSelected($event)"
          [disabled]="uploadStatus === 'processing'"
          class="gnv-file-input"
        />
        Seleccionar CSV
      </label>

      <button
        *ngIf="selectedFile"
        (click)="uploadCSV()"
        [disabled]="uploadStatus === 'processing'"
        class="btn btn-primary btn-sm gnv-upload__button"
      >
        {{ uploadStatus === 'processing' ? 'Procesando...' : 'Subir Archivo' }}
      </button>
    </div>

    <div *ngIf="selectedFile" class="gnv-upload__file">
      Archivo seleccionado: <strong>{{ selectedFile.name }}</strong>
      ({{ (selectedFile.size / 1024) | number:'1.0-0' }} KB)
    </div>

    <div class="gnv-upload__actions">
      <a
        href="assets/gnv/template.csv"
        download
        class="btn btn-secondary btn-sm gnv-upload__button"
        data-cy="dl-template"
      >
        Plantilla CSV
      </a>
      <a
        href="assets/gnv/gnv_guide.pdf"
        target="_blank"
        rel="noopener"
        class="btn btn-secondary btn-sm gnv-upload__button"
        data-cy="dl-guide"
      >
        <app-icon name="book" [size]="24" class="gnv-upload__icon" />
        Guía PDF
      </a>
      <a
        href="assets/gnv/ingesta_yesterday.csv"
        download
        class="btn btn-secondary btn-sm gnv-upload__button"
        data-cy="dl-latest"
      >
        Descargar Última Ingesta
      </a>
    </div>
  </div>

  <div *ngIf="rows().length > 0; else emptyTpl">
    <div class="gnv-summary">
      <div class="gnv-summary-card">
        <div class="gnv-summary-card__value">{{ getTotalStations() }}</div>
        <div class="gnv-summary-card__label">Estaciones</div>
      </div>
      <div class="gnv-summary-card gnv-summary-card--green">
        <div class="gnv-summary-card__value">{{ getHealthyStations() }}</div>
        <div class="gnv-summary-card__label">Saludables</div>
      </div>
      <div class="gnv-summary-card gnv-summary-card--yellow">
        <div class="gnv-summary-card__value">{{ getWarningStations() }}</div>
        <div class="gnv-summary-card__label">Con Avisos</div>
      </div>
      <div class="gnv-summary-card gnv-summary-card--red">
        <div class="gnv-summary-card__value">{{ getCriticalStations() }}</div>
        <div class="gnv-summary-card__label">Críticas</div>
      </div>
    </div>

    <div *ngIf="isLoading()" class="gnv-skeleton">
      <div *ngFor="let _ of [1, 2, 3]" class="gnv-skeleton__item"></div>
    </div>

    <div *ngIf="!isLoading()" class="gnv-station-grid">
      <div
        *ngFor="let r of rows(); trackBy: trackByStation"
        class="gnv-station-card"
        [class.gnv-station-card--green]="r.status === 'green'"
        [class.gnv-station-card--yellow]="r.status === 'yellow'"
        [class.gnv-station-card--red]="r.status === 'red'"
      >
        <div class="gnv-station-card__header">
          <div class="gnv-station-card__identity">
            <span
              class="gnv-state-indicator"
              [class.gnv-state-indicator--green]="r.status === 'green'"
              [class.gnv-state-indicator--yellow]="r.status === 'yellow'"
              [class.gnv-state-indicator--red]="r.status === 'red'"
              [attr.data-cy]="'status-' + r.status"
              [title]="r.status | titlecase"
            ></span>
            <h3 class="gnv-station-card__title">{{ r.stationName }}</h3>
          </div>
          <span
            class="gnv-status-pill"
            [class.gnv-status-pill--green]="r.status === 'green'"
            [class.gnv-status-pill--yellow]="r.status === 'yellow'"
            [class.gnv-status-pill--red]="r.status === 'red'"
          >
            {{ getStatusText(r.status) }}
          </span>
        </div>

        <div class="gnv-station-card__stats">
          <div class="gnv-stat-row">
            <span class="gnv-stat-label">Archivo:</span>
            <span class="gnv-stat-value">{{ r.fileName || '—' }}</span>
          </div>
          <div class="gnv-stat-row">
            <span class="gnv-stat-label">Total:</span>
            <span class="gnv-stat-value gnv-stat-value--mono">{{ r.rowsTotal | number }}</span>
          </div>
          <div class="gnv-stat-row">
            <span class="gnv-stat-label">Aceptadas:</span>
            <span class="gnv-stat-value gnv-stat-value--positive gnv-stat-value--mono">{{ r.rowsAccepted | number }}</span>
          </div>
          <div class="gnv-stat-row">
            <span class="gnv-stat-label">Rechazadas:</span>
            <span class="gnv-stat-value gnv-stat-value--negative gnv-stat-value--mono">{{ r.rowsRejected | number }}</span>
          </div>
          <div class="gnv-stat-row">
            <span class="gnv-stat-label">Warnings:</span>
            <span class="gnv-stat-value gnv-stat-value--warning gnv-stat-value--mono">{{ r.warnings | number }}</span>
          </div>
        </div>

        <div class="gnv-station-card__actions">
          <button class="btn btn-secondary btn-sm gnv-station-card__button">
            Ver Detalles
          </button>
        </div>
      </div>
    </div>
  </div>

  <ng-template #emptyTpl>
    <div class="gnv-empty">
      <div class="gnv-empty__icon">GNV</div>
      <h3 class="gnv-empty__title">Sin datos de ingesta</h3>
      <p class="gnv-empty__description">
        No hay datos de ingesta disponibles para mostrar
      </p>
    </div>
  </ng-template>
</section>
