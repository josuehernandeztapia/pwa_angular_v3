<div class="catalog-page__container">
  <header class="catalog-page__header">
    <div class="catalog-page__header-content">
      <div class="catalog-page__title-group">
        <app-icon name="calculator" [size]="24" class="catalog-page__title-icon" aria-hidden="true" />
        <h1 class="catalog-page__title">Catálogo de Productos</h1>
      </div>
      <p class="catalog-page__description">Paquetes de unidades vehiculares por mercado</p>
    </div>

    <div class="catalog-page__header-actions">
      <button type="button" class="catalog-page__button catalog-page__button--secondary" (click)="simulateDemo()">
        Mostrar demo
      </button>
    </div>
  </header>

  <section class="catalog-page__filters" aria-label="Filtros de productos">
    <div class="catalog-page__filter-group">
      <button
        *ngFor="let market of markets"
        type="button"
        [ngClass]="getMarketButtonClasses(market.value)"
        [attr.aria-pressed]="selectedMarket === market.value"
        [attr.aria-label]="'Filtrar por mercado: ' + market.label"
        (click)="selectMarket(market.value)"
      >
        <app-icon
          [name]="market.icon"
          [size]="16"
          class="catalog-page__filter-icon"
          aria-hidden="true"
        ></app-icon>
        {{ market.label }}
      </button>
    </div>

    <div class="catalog-page__filter-group catalog-page__filter-group--types">
      <button
        *ngFor="let type of productTypes"
        type="button"
        [ngClass]="getTypeButtonClasses(type.value)"
        [attr.aria-pressed]="selectedType === type.value"
        [attr.aria-label]="'Filtrar por tipo: ' + type.label"
        (click)="selectType(type.value)"
      >
        {{ type.label }}
      </button>
    </div>

    <div class="catalog-page__filters-actions" *ngIf="selectedMarket !== 'all' || selectedType !== 'all'">
      <button type="button" class="catalog-page__button catalog-page__button--secondary" (click)="resetFilters()" aria-label="Limpiar filtros activos">
        Limpiar filtros
      </button>
    </div>
  </section>

  <section *ngIf="isLoading" class="catalog-page__loading" role="status" aria-live="polite" aria-busy="true">
    <p class="catalog-page__loading-text">Cargando catálogo de productos…</p>
  </section>

  <div *ngIf="!isLoading" class="catalog-page__grid">
    <article
      *ngFor="let producto of filteredProducts; trackBy: trackByProductId"
      [ngClass]="getProductCardClasses(producto)"
    >
      <div *ngIf="producto.isPopular" class="catalog-card__badge">
        <app-icon name="star" [size]="20" class="catalog-card__badge-icon" aria-hidden="true" />
        Más popular
      </div>

      <header class="catalog-card__header">
        <div class="catalog-card__title">
          <h3 class="catalog-card__name">{{ producto.name }}</h3>
          <span class="catalog-card__market">{{ getMarketLabel(producto.market) }}</span>
        </div>
        <div class="catalog-card__price">
          <span class="catalog-card__price-amount">{{ formatCurrency(producto.basePrice) }}</span>
          <span class="catalog-card__price-label">Precio base</span>
        </div>
      </header>

      <div class="catalog-card__body">
        <section class="catalog-card__section" aria-label="Componentes del paquete">
          <h4 class="catalog-card__section-title">
            <app-icon name="cube" [size]="24" class="catalog-card__section-icon" aria-hidden="true" />
            Componentes del paquete
          </h4>
          <div class="catalog-card__components">
            <div *ngFor="let component of producto.components" [ngClass]="getComponentClasses(component)">
              <div class="catalog-card__component-info">
                <span class="catalog-card__component-name">{{ component.name }}</span>
                <span *ngIf="component.isOptional" class="catalog-card__component-pill catalog-card__component-pill--muted">Opcional</span>
                <span *ngIf="component.isMultipliedByTerm" class="catalog-card__component-pill">Anual</span>
              </div>
              <span class="catalog-card__component-price">{{ formatCurrency(component.price) }}</span>
            </div>
          </div>
        </section>

        <section *ngIf="producto.features.length > 0" class="catalog-card__section" aria-label="Características">
          <h4 class="catalog-card__section-title">Características</h4>
          <div class="catalog-card__features">
            <span *ngFor="let feature of producto.features" class="catalog-card__feature">{{ feature }}</span>
          </div>
        </section>

        <section class="catalog-card__section" aria-label="Condiciones financieras">
          <h4 class="catalog-card__section-title"><app-icon name="currency-dollar" [size]="18" class="catalog-card__section-icon" /> Condiciones financieras</h4>
          <div class="catalog-card__financial-grid">
            <div class="catalog-card__financial-item" *ngIf="producto.rate">
              <span class="catalog-card__financial-label">Tasa anual</span>
              <span class="catalog-card__financial-value">{{ (producto.rate * 100).toFixed(1) }}%</span>
            </div>
            <div class="catalog-card__financial-item">
              <span class="catalog-card__financial-label">Enganche mín.</span>
              <span class="catalog-card__financial-value">{{ (producto.minDownPayment * 100).toFixed(0) }}%</span>
            </div>
            <div class="catalog-card__financial-item" *ngIf="producto.terms?.length">
              <span class="catalog-card__financial-label">Plazos</span>
              <span class="catalog-card__financial-value">{{ producto.terms?.join(', ') }} meses</span>
            </div>
          </div>
        </section>
      </div>

      <footer class="catalog-card__actions">
        <button type="button" class="catalog-page__button catalog-page__button--secondary" (click)="viewDetails(producto.id)">
          <app-icon name="eye" [size]="18" class="catalog-card__action-icon" aria-hidden="true"></app-icon>
          Ver detalles
        </button>
        <button type="button" class="catalog-page__button catalog-page__button--primary" (click)="startQuote(producto)">
          <app-icon name="arrow-right" [size]="18" class="catalog-card__action-icon" aria-hidden="true"></app-icon>
          Cotizar ahora
        </button>
      </footer>
    </article>
  </div>

  <app-empty-state-card
    *ngIf="!isLoading && filteredProducts.length === 0"
    [iconName]="null"
    title="Sin resultados"
    subtitle="No se encontraron productos para los filtros seleccionados"
    [primaryCtaLabel]="'Mostrar todos'"
    (primary)="resetFilters()"
    (secondary)="simulateDemo()"
  ></app-empty-state-card>
</div>
