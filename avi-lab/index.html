<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª AVI_LAB - Voice Analysis Laboratory</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ğŸ§ª AVI_LAB</h1>
            <p>Voice Analysis & Testing Laboratory</p>
            <div class="status" id="status">Ready</div>
        </header>

        <!-- Voice Controls -->
        <section class="voice-section">
            <h2>ğŸ¤ Voice Testing</h2>
            
            <div class="controls">
                <button id="recordBtn" class="btn primary">ğŸ™ï¸ Record</button>
                <button id="stopBtn" class="btn secondary" disabled>â¹ï¸ Stop</button>
                <button id="playBtn" class="btn secondary" disabled>â–¶ï¸ Play</button>
                <input type="file" id="fileInput" accept="audio/*" class="file-input">
                <button id="uploadBtn" class="btn secondary">ğŸ“ Upload Audio</button>
            </div>

            <div class="audio-info" id="audioInfo">
                <p><strong>Duration:</strong> <span id="audioDuration">0</span>s</p>
                <p><strong>Size:</strong> <span id="audioSize">0</span> KB</p>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="dashboard">ğŸ“Š Dashboard</button>
            <button class="tab-btn" data-tab="questions">â“ Questions</button>
            <button class="tab-btn" data-tab="voice">ğŸ¤ Voice Lab</button>
            <button class="tab-btn" data-tab="hase">ğŸ§® HASE Model</button>
            <button class="tab-btn" data-tab="testing">ğŸ§ª Test Suite</button>
            <button class="tab-btn" data-tab="calibration">âš™ï¸ Calibration</button>
            <button class="tab-btn" data-tab="benchmark">ğŸ“ˆ Benchmark</button>
        </nav>

        <!-- Tab Content Containers -->
        <div class="tab-content">
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-panel active">
                <!-- Question Selection -->
                <section class="question-section">
                    <h2>â“ Test Question</h2>
                    <select id="questionSelect" class="question-select">
                        <option value="ingresos_promedio_diarios">Â¿CuÃ¡les son sus ingresos promedio diarios?</option>
                        <option value="gasto_diario_gasolina">Â¿CuÃ¡nto gasta al dÃ­a en gasolina?</option>
                        <option value="gastos_mordidas_cuotas">Â¿CuÃ¡nto paga de cuotas o "apoyos" a la semana?</option>
                        <option value="margen_disponible_credito">Â¿CuÃ¡nto le queda libre mensual?</option>
                        <option value="seasonal_vulnerability">Â¿En quÃ© Ã©poca del aÃ±o se te complica mÃ¡s trabajar?</option>
                    </select>
                </section>
            </div>

            <!-- Questions Tab -->
            <div id="questions" class="tab-panel">
                <section class="questions-explorer">
                    <h2>ğŸ“‹ AVI Questions Explorer (55/55 âœ…)</h2>
                    <div class="questions-controls">
                        <select id="categoryFilter" class="filter-select">
                            <option value="all">ğŸ” All Categories (55)</option>
                            <option value="ingresos">ğŸ’° Ingresos & OperaciÃ³n (12)</option>
                            <option value="gastos">ğŸ“Š Gastos & Costos (10)</option>
                            <option value="vulnerabilidades">âš ï¸ Vulnerabilidades (8)</option>
                            <option value="capacidad_pago">ğŸ’³ Capacidad de Pago (7)</option>
                            <option value="resiliencia">ğŸ’ª Resiliencia & AdaptaciÃ³n (6)</option>
                            <option value="estructura_negocio">ğŸ—ï¸ Estructura de Negocio (4)</option>
                            <option value="patrimonio_activos">ğŸ  Patrimonio & Activos (4)</option>
                            <option value="historial_crediticio">ğŸ“ˆ Historial Crediticio (4)</option>
                        </select>
                        <button id="testRandomBtn" class="btn secondary">ğŸ² Test Random</button>
                    </div>
                    <div id="questionsContainer" class="questions-grid"></div>
                </section>
            </div>

            <!-- Voice Lab Tab -->
            <div id="voice" class="tab-panel">
                <section class="voice-lab">
                    <h2>ğŸ¤ Voice Analysis Laboratory</h2>
                    <div class="voice-metrics-display">
                        <h3>ğŸ“Š Mathematical Algorithm Visualization</h3>
                        <div class="algorithm-formula">
                            <code>voiceScore = wâ‚Ã—(1-L) + wâ‚‚Ã—(1-P) + wâ‚ƒÃ—(1-D) + wâ‚„Ã—E + wâ‚…Ã—H</code>
                        </div>
                        <div class="weights-display">
                            <span class="weight">wâ‚=0.25 (Latency)</span>
                            <span class="weight">wâ‚‚=0.20 (Pitch Var)</span>
                            <span class="weight">wâ‚ƒ=0.15 (Disfluency)</span>
                            <span class="weight">wâ‚„=0.20 (Energy)</span>
                            <span class="weight">wâ‚…=0.20 (Honesty)</span>
                        </div>
                        <div id="voiceMetricsChart" class="metrics-chart"></div>
                        <button id="generateMockDataBtn" class="btn secondary">ğŸ§ª Generate Mock Analysis</button>
                    </div>
                </section>
            </div>

            <!-- HASE Model Tab -->
            <div id="hase" class="tab-panel">
                <section class="hase-calculator">
                    <h2>ğŸ§® HASE Model Calculator</h2>
                    <div class="hase-info">
                        <p><strong>HASE Formula:</strong> Historical (30%) + Geographic (20%) + Voice/AVI (50%)</p>
                    </div>
                    <div class="hase-inputs">
                        <div class="input-group">
                            <label>ğŸ“Š Historical Score (0-1000):</label>
                            <input type="range" id="historicalSlider" min="0" max="1000" value="650">
                            <span id="historicalValue">650</span>
                        </div>
                        <div class="input-group">
                            <label>ğŸ—ºï¸ Geographic Score (0-1000):</label>
                            <input type="range" id="geographicSlider" min="0" max="1000" value="500">
                            <span id="geographicValue">500</span>
                        </div>
                        <div class="input-group">
                            <label>ğŸ¤ Voice Score (0-1000):</label>
                            <input type="range" id="voiceSlider" min="0" max="1000" value="750">
                            <span id="voiceValue">750</span>
                        </div>
                    </div>
                    <div class="hase-results">
                        <div class="hase-score-display">
                            <span id="haseScore">663</span>/1000
                        </div>
                        <div id="haseDecision" class="decision REVIEW">REVIEW</div>
                        <div id="haseRisk" class="risk-level">MEDIUM RISK</div>
                    </div>
                    <button id="generateMockProfileBtn" class="btn secondary">ğŸ‘¤ Generate Mock Profile</button>
                </section>
            </div>

            <!-- Testing Suite Tab -->
            <div id="testing" class="tab-panel">
                <section class="testing-suite">
                    <h2>ğŸ§ª AVI Testing Suite</h2>
                    <div class="testing-controls">
                        <button id="runVoiceTestBtn" class="btn primary">ğŸ¤ Run Voice Algorithm Test</button>
                        <button id="runHASETestBtn" class="btn primary">ğŸ§® Run HASE Model Test</button>
                        <button id="runQuestionsTestBtn" class="btn primary">â“ Run Questions Test</button>
                        <button id="runBenchmarkTestBtn" class="btn primary">ğŸ“Š Run Benchmark Test</button>
                    </div>
                    <div id="testResults" class="test-results"></div>
                </section>
            </div>

            <!-- Calibration Tab -->
            <div id="calibration" class="tab-panel">
                <section class="calibration-section">
                    <h2>âš™ï¸ AVI Calibration System</h2>
                    <div id="calibrationInterface">
                        <!-- Calibration UI will be rendered here -->
                    </div>
                </section>
            </div>

            <!-- Benchmark Tab -->
            <div id="benchmark" class="tab-panel">
                <section class="benchmark-dashboard">
                    <h2>ğŸ“ˆ Benchmark & Analytics</h2>
                    <div class="benchmark-controls">
                        <button id="clearBenchmarkBtn" class="btn danger">ğŸ—‘ï¸ Clear All Data</button>
                        <button id="exportBenchmarkBtn" class="btn secondary">ğŸ’¾ Export CSV</button>
                        <button id="generateReportBtn" class="btn secondary">ğŸ“„ Generate Report</button>
                    </div>
                    <div class="benchmark-stats">
                        <div class="stat-card">
                            <h3>Total Tests</h3>
                            <span id="totalTests">0</span>
                        </div>
                        <div class="stat-card">
                            <h3>Avg Score</h3>
                            <span id="avgScore">-</span>
                        </div>
                        <div class="stat-card">
                            <h3>GO Rate</h3>
                            <span id="goRate">-</span>
                        </div>
                    </div>
                    <div id="benchmarkChart" class="benchmark-chart"></div>
                </section>
            </div>

        </div> <!-- End tab-content -->

        <!-- Analysis Button -->
        <section class="analyze-section">
            <button id="analyzeBtn" class="btn analyze" disabled>ğŸ§  Analyze with AVI + Whisper</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing with OpenAI Whisper...</p>
            </div>
        </section>

        <!-- Results Dashboard -->
        <section class="results-section" id="resultsSection">
            <h2>ğŸ“Š Analysis Results</h2>
            
            <div class="result-cards">
                <!-- Whisper Results -->
                <div class="card whisper-card">
                    <h3>ğŸ—£ï¸ Transcription</h3>
                    <p id="transcription" class="transcription">-</p>
                    <small>Confidence: <span id="whisperConfidence">-</span>%</small>
                </div>

                <!-- AVI Score -->
                <div class="card score-card">
                    <h3>ğŸ¯ AVI Score</h3>
                    <div class="score-display">
                        <span id="aviScore" class="score">-</span>
                        <span class="score-suffix">/1000</span>
                    </div>
                    <div id="decision" class="decision">-</div>
                </div>

                <!-- Voice Metrics -->
                <div class="card metrics-card">
                    <h3>ğŸ“ˆ Voice Metrics</h3>
                    <div class="metrics">
                        <div class="metric">
                            <label>Latency:</label>
                            <span id="latencyIndex">-</span>
                        </div>
                        <div class="metric">
                            <label>Pitch Variance:</label>
                            <span id="pitchVar">-</span>
                        </div>
                        <div class="metric">
                            <label>Energy Stability:</label>
                            <span id="energyStability">-</span>
                        </div>
                        <div class="metric">
                            <label>Honesty Lexicon:</label>
                            <span id="honestyLexicon">-</span>
                        </div>
                    </div>
                </div>

                <!-- Flags -->
                <div class="card flags-card">
                    <h3>ğŸš© Analysis Flags</h3>
                    <div id="analysisFlags" class="flags">No flags</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="result-actions">
                <button id="exportBtn" class="btn secondary">ğŸ’¾ Export JSON</button>
                <button id="benchmarkBtn" class="btn secondary">ğŸ“Š Add to Benchmark</button>
                <button id="resetBtn" class="btn secondary">ğŸ”„ Reset</button>
            </div>
        </section>

        <!-- Benchmark Dashboard -->
        <section class="benchmark-section" id="benchmarkSection">
            <h2>ğŸ“Š Benchmark Results</h2>
            <div id="benchmarkData" class="benchmark-data">
                <p>No benchmark data yet. Analyze some audio files to see comparisons!</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>ğŸš€ Powered by OpenAI Whisper + NestJS BFF + AVI Engine</p>
            <p><strong>BFF Status:</strong> <span id="bffStatus">Checking...</span></p>
        </footer>
    </div>

    <!-- Audio Element -->
    <audio id="audioPlayer" controls></audio>

    <!-- Load complete AVI system modules and expose to window for app-complete.js -->
    <script type="module">
      try {
        const { ALL_AVI_QUESTIONS, AVI_CONFIG } = await import('./src/data/avi-questions-complete.js');
        const { VoiceAnalysisEngine } = await import('./src/services/voice-analysis-engine.js');
        const { HASEModel } = await import('./src/services/hase-model.js');
        const { AVICalibrationSystem } = await import('./src/calibration-system.js');
        const { AVICalibrationUI } = await import('./src/calibration-ui.js');
        
        window.ALL_AVI_QUESTIONS = ALL_AVI_QUESTIONS;
        window.AVI_CONFIG = AVI_CONFIG;
        window.voiceEngine = new VoiceAnalysisEngine();
        window.haseModel = new HASEModel();
        window.calibrationSystem = new AVICalibrationSystem();
        window.calibrationUI = new AVICalibrationUI();
        
        // Initialize calibration interface
        window.calibrationUI.renderCalibrationInterface();
        
        // Notify that modules are loaded
        window.dispatchEvent(new CustomEvent('aviModulesLoaded'));
      } catch (error) {
        console.error('Failed to load AVI modules:', error);
        // Fallback: provide basic functionality
        window.ALL_AVI_QUESTIONS = [];
        window.AVI_CONFIG = { total_questions: 55, implemented_questions: 55 };
        window.voiceEngine = { computeVoiceScore: () => ({ success: false, error: 'Module loading failed' }) };
        window.haseModel = { calculateHASEScore: () => ({ totalScore: 0, decision: 'ERROR' }) };
        window.calibrationSystem = { startCalibration: () => console.log('Calibration system not available') };
        window.calibrationUI = { renderCalibrationInterface: () => console.log('Calibration UI not available') };
        window.dispatchEvent(new CustomEvent('aviModulesLoaded'));
      }
    </script>
    <script src="app-complete.js"></script>
</body>
</html>
